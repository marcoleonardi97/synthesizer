<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.08.06 -->
        <title>synthesizer.emission_models.base_model - Synthesizer</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">Synthesizer</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../_static/synthesizer_logo.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../getting_started/getting_started.html">Getting Started</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Getting Started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/downloading_grids.html">Downloading Grids</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/overview.html">Overview</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../grids/grids.html">Grids</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Grids</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../grids/grids_example.html"><code class="docutils literal notranslate"><span class="pre">Grid</span></code> example</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../galaxy/galaxy.html">Galaxy</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Galaxy</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../galaxy/particle_parametric.html">Particle vs Parametric</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../galaxy/line_of_sight.html">Line of Sight Calculations</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../components/components.html">Components</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Components</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../components/stars.html">Stars</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../components/gas.html">Gas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../components/blackholes.html">Blackholes</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../sed/sed.html">Sed</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Sed</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../sed/sed_example.html">The Sed object</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../emission_models/emission_models.html">Emission models</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Emission models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../emission_models/model_usage.html">Emission model basics</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../emission_models/premade_models/premade_models.html">Premade Models</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Premade Models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../emission_models/premade_models/stellar_models.html">Stellar Emission Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../emission_models/premade_models/agn_models.html">AGN Emission Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../emission_models/premade_models/common_models.html">Common Models</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../emission_models/dust_emission.html">Dust emission</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../emission_models/modify_models.html">Modifying a model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../emission_models/custom_models.html">Creating your own EmissionModel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../emission_models/custom_models.html#Saving-or-not-saving-the-emission">Saving or not saving the emission</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../emission_models/combined_models.html">Combined Emission Models</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../attenuation/attenuation.html">Attenuation</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Attenuation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../attenuation/dust_attenuation.html">Dust Attenuation Curves</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../attenuation/igm.html">Intergalactic Medium Absortion</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../spectra/spectra.html">Generating spectra</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Generating spectra</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../spectra/stars.html">Stellar Spectra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../spectra/blackholes.html">Black Hole Spectra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../spectra/galaxy.html">Galaxy Spectra</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../lines/lines.html">Emission Lines</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of Emission Lines</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../lines/grid_lines.html">Lines from <code class="docutils literal notranslate"><span class="pre">Grid</span></code> objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../lines/galaxy_lines.html">Lines from <code class="docutils literal notranslate"><span class="pre">Galaxy</span></code> objects</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../filters/filters.html">Filters</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of Filters</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../filters/filters_example.html">Filters example</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../photometry/photometry.html">Photometry</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of Photometry</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../photometry/photometry_example.html">Generating Photometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../photometry/galaxy_phot.html">Generating photometry from a <code class="docutils literal notranslate"><span class="pre">Galaxy</span></code></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../imaging/imaging.html">Imaging</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of Imaging</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../imaging/particle_imaging.html">Images From Galaxy Particle distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../imaging/parametric_imaging.html">Images From Parametric Galaxies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../imaging/particle_data_cube.html">Spectral Data Cubes from Galaxy Particle distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../imaging/parametric_data_cube.html">Spectral Data Cubes from a Parametric Galaxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../imaging/property_maps.html">Property maps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../parallelism/openmp.html">Parallelism</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../advanced/advanced.html">Advanced</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of Advanced</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../advanced/config_options.html">Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../advanced/units.html">Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../advanced/abundances.html">Abundances</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../advanced/creating_grids.html">Creating Grids</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../notebook_examples/cookbook.html">Cookbook</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of Cookbook</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../notebook_examples/generate_active_galaxy.html">Generate active galaxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebook_examples/generate_composite_galaxy.html">Generate composite galaxy</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../auto_examples/index.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../auto_examples/cosmo/index.html">Cosmological simulation examples</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of Cosmological simulation examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/cosmo/plot_test_los_spectra.html">Line of sight example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/cosmo/plot_test_age_lookup.html">Age lookup test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/cosmo/plot_test_aperture_mask.html">Aperture Mask Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/cosmo/plot_sc-sam.html">SC-SAM example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/cosmo/plot_parametric_young_stars.html">Parametric Young Stars Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/cosmo/plot_cosmo_example.html">Camels example</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../auto_examples/general/index.html">General examples</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of General examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/general/plot_igm.html">IGM transmission example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/general/plot_dustcurves.html">Dust curves example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/general/plot_filters.html">Filters example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/general/plot_quiescent_colours.html">Plot quiescent UVJ diagram</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/general/plot_photometry.html">Photometry example</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../auto_examples/grids/index.html">Grid examples</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of Grid examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/grids/plot_log10Q.html">Plot ionising luminosity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/grids/plot_line_cont.html">Plot the line continuum for a given grid point</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/grids/plot_spectra.html">Plot spectra example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/grids/plot_lines.html">Get lines example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/grids/plot_spectra_by_age.html">Plot spectra by age</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../auto_examples/imaging/index.html">Imaging examples</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of Imaging examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/imaging/plot_aperture_sum.html">Get sum of image inside an aperture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/imaging/plot_image_addition.html">Image addition example</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../auto_examples/parametric/index.html">Parametric galaxy examples</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><div class="visually-hidden">Toggle navigation of Parametric galaxy examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/parametric/plot_compare_sfhs.html">Compare different parametric star formation history models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/parametric/plot_delta_lambda.html">Plot delta_lambda for a grid.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/parametric/plot_create_image.html">Create image example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/parametric/plot_generate_lines.html">Generating Lines from a Parametric Galaxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/parametric/plot_observed_sed.html">Generate parametric observed SED</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/parametric/plot_scale_by_luminosity.html">An example showing how to scale a galaxy’s mass by luminosity/flux.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/parametric/plot_sed.html">Generate parametric galaxy SED</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/parametric/plot_equivalent_width.html">Plot equivalent width for UV indices</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../auto_examples/particle/index.html">Particle galaxy examples</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><div class="visually-hidden">Toggle navigation of Particle galaxy examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/particle/plot_create_sampled_sed.html">Create sampled SED</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/particle/plot_compare_parametric_particle.html">Compare parametric and particle SEDs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/particle/plot_compare_grid_assignment.html">Compare SPS grid assignment methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/particle/plot_single_star_test.html">Compare Single star particle to instantaneous SFZH</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/particle/plot_los_spectra.html">Plot line of sight diagnostics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/particle/plot_get_los_attenutation.html">Plot line of sight optical depth calculations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../auto_examples/particle/plot_rotated_galaxy.html">Rotating particle distributions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../API.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.html">synthesizer</a><input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><div class="visually-hidden">Toggle navigation of synthesizer</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.abundances.html">synthesizer.abundances</a><input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><div class="visually-hidden">Toggle navigation of synthesizer.abundances</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.abundances.abundance_patterns.html">synthesizer.abundances.abundance_patterns</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.abundances.abundance_scalings.html">synthesizer.abundances.abundance_scalings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.abundances.depletion_models.html">synthesizer.abundances.depletion_models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.abundances.elements.html">synthesizer.abundances.elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.abundances.reference_abundance_patterns.html">synthesizer.abundances.reference_abundance_patterns</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.base_galaxy.html">synthesizer.base_galaxy</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.components.html">synthesizer.components</a><input class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><div class="visually-hidden">Toggle navigation of synthesizer.components</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.components.blackhole.html">synthesizer.components.blackhole</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.components.stellar.html">synthesizer.components.stellar</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.components.unified_agn.html">synthesizer.components.unified_agn</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.conversions.html">synthesizer.conversions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.download_data.html">synthesizer.download_data</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.html">synthesizer.emission_models</a><input class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><div class="visually-hidden">Toggle navigation of synthesizer.emission_models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.agn.html">synthesizer.emission_models.agn</a><input class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" role="switch" type="checkbox"/><label for="toctree-checkbox-28"><div class="visually-hidden">Toggle navigation of synthesizer.emission_models.agn</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.agn.models.html">synthesizer.emission_models.agn.models</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.agn.unified_agn.html">synthesizer.emission_models.agn.unified_agn</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.attenuation.html">synthesizer.emission_models.attenuation</a><input class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" role="switch" type="checkbox"/><label for="toctree-checkbox-29"><div class="visually-hidden">Toggle navigation of synthesizer.emission_models.attenuation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.attenuation.dust.html">synthesizer.emission_models.attenuation.dust</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.attenuation.igm.html">synthesizer.emission_models.attenuation.igm</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.base_model.html">synthesizer.emission_models.base_model</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.dust.html">synthesizer.emission_models.dust</a><input class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" role="switch" type="checkbox"/><label for="toctree-checkbox-30"><div class="visually-hidden">Toggle navigation of synthesizer.emission_models.dust</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.dust.emission.html">synthesizer.emission_models.dust.emission</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.models.html">synthesizer.emission_models.models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.operations.html">synthesizer.emission_models.operations</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.stellar.html">synthesizer.emission_models.stellar</a><input class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" role="switch" type="checkbox"/><label for="toctree-checkbox-31"><div class="visually-hidden">Toggle navigation of synthesizer.emission_models.stellar</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.stellar.models.html">synthesizer.emission_models.stellar.models</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../_autosummary/synthesizer.emission_models.stellar.pacman_model.html">synthesizer.emission_models.stellar.pacman_model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.html">synthesizer.exceptions</a><input class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" role="switch" type="checkbox"/><label for="toctree-checkbox-32"><div class="visually-hidden">Toggle navigation of synthesizer.exceptions</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.DownloadError.html">synthesizer.exceptions.DownloadError</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.GridError.html">synthesizer.exceptions.GridError</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.InconsistentAddition.html">synthesizer.exceptions.InconsistentAddition</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.InconsistentArguments.html">synthesizer.exceptions.InconsistentArguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.InconsistentCoordinates.html">synthesizer.exceptions.InconsistentCoordinates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.InconsistentParameter.html">synthesizer.exceptions.InconsistentParameter</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.InconsistentWavelengths.html">synthesizer.exceptions.InconsistentWavelengths</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.IncorrectUnits.html">synthesizer.exceptions.IncorrectUnits</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.MissingArgument.html">synthesizer.exceptions.MissingArgument</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.MissingAttribute.html">synthesizer.exceptions.MissingAttribute</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.MissingImage.html">synthesizer.exceptions.MissingImage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.MissingSpectraType.html">synthesizer.exceptions.MissingSpectraType</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.MissingUnits.html">synthesizer.exceptions.MissingUnits</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.SVOFilterNotFound.html">synthesizer.exceptions.SVOFilterNotFound</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.SVOInaccessible.html">synthesizer.exceptions.SVOInaccessible</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.UnimplementedFunctionality.html">synthesizer.exceptions.UnimplementedFunctionality</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.UnknownImageType.html">synthesizer.exceptions.UnknownImageType</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.UnmetDependency.html">synthesizer.exceptions.UnmetDependency</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.UnrecognisedOption.html">synthesizer.exceptions.UnrecognisedOption</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.exceptions.WavelengthOutOfRange.html">synthesizer.exceptions.WavelengthOutOfRange</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.filters.html">synthesizer.filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.galaxy.html">synthesizer.galaxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.grid.html">synthesizer.grid</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.imaging.html">synthesizer.imaging</a><input class="toctree-checkbox" id="toctree-checkbox-33" name="toctree-checkbox-33" role="switch" type="checkbox"/><label for="toctree-checkbox-33"><div class="visually-hidden">Toggle navigation of synthesizer.imaging</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.imaging.extensions.html">synthesizer.imaging.extensions</a><input class="toctree-checkbox" id="toctree-checkbox-34" name="toctree-checkbox-34" role="switch" type="checkbox"/><label for="toctree-checkbox-34"><div class="visually-hidden">Toggle navigation of synthesizer.imaging.extensions</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../_autosummary/synthesizer.imaging.extensions.circular_aperture.html">synthesizer.imaging.extensions.circular_aperture</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../_autosummary/synthesizer.imaging.extensions.image.html">synthesizer.imaging.extensions.image</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../_autosummary/synthesizer.imaging.extensions.spectral_cube.html">synthesizer.imaging.extensions.spectral_cube</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.imaging.image.html">synthesizer.imaging.image</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.imaging.image_collection.html">synthesizer.imaging.image_collection</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.imaging.spectral_cube.html">synthesizer.imaging.spectral_cube</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.kernel_functions.html">synthesizer.kernel_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.line.html">synthesizer.line</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.line_ratios.html">synthesizer.line_ratios</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.load_data.html">synthesizer.load_data</a><input class="toctree-checkbox" id="toctree-checkbox-35" name="toctree-checkbox-35" role="switch" type="checkbox"/><label for="toctree-checkbox-35"><div class="visually-hidden">Toggle navigation of synthesizer.load_data</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.load_data.load_camels.html">synthesizer.load_data.load_camels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.load_data.load_flares.html">synthesizer.load_data.load_flares</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.load_data.load_scsam.html">synthesizer.load_data.load_scsam</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.load_data.load_simba.html">synthesizer.load_data.load_simba</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.load_data.utils.html">synthesizer.load_data.utils</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.parametric.html">synthesizer.parametric</a><input class="toctree-checkbox" id="toctree-checkbox-36" name="toctree-checkbox-36" role="switch" type="checkbox"/><label for="toctree-checkbox-36"><div class="visually-hidden">Toggle navigation of synthesizer.parametric</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.parametric.blackholes.html">synthesizer.parametric.blackholes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.parametric.galaxy.html">synthesizer.parametric.galaxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.parametric.metal_dist.html">synthesizer.parametric.metal_dist</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.parametric.morphology.html">synthesizer.parametric.morphology</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.parametric.sf_hist.html">synthesizer.parametric.sf_hist</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.parametric.stars.html">synthesizer.parametric.stars</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.particle.html">synthesizer.particle</a><input class="toctree-checkbox" id="toctree-checkbox-37" name="toctree-checkbox-37" role="switch" type="checkbox"/><label for="toctree-checkbox-37"><div class="visually-hidden">Toggle navigation of synthesizer.particle</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.particle.blackholes.html">synthesizer.particle.blackholes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.particle.galaxy.html">synthesizer.particle.galaxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.particle.gas.html">synthesizer.particle.gas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.particle.particles.html">synthesizer.particle.particles</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.particle.stars.html">synthesizer.particle.stars</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.photoionisation.html">synthesizer.photoionisation</a><input class="toctree-checkbox" id="toctree-checkbox-38" name="toctree-checkbox-38" role="switch" type="checkbox"/><label for="toctree-checkbox-38"><div class="visually-hidden">Toggle navigation of synthesizer.photoionisation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.photoionisation.cloudy17.html">synthesizer.photoionisation.cloudy17</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.photoionisation.cloudy23.html">synthesizer.photoionisation.cloudy23</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.photoionisation.photoionisation.html">synthesizer.photoionisation.photoionisation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.photometry.html">synthesizer.photometry</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.sed.html">synthesizer.sed</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.units.html">synthesizer.units</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../_autosummary/synthesizer.utils.html">synthesizer.utils</a><input class="toctree-checkbox" id="toctree-checkbox-39" name="toctree-checkbox-39" role="switch" type="checkbox"/><label for="toctree-checkbox-39"><div class="visually-hidden">Toggle navigation of synthesizer.utils</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.utils.art.html">synthesizer.utils.art</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.utils.ascii_table.html">synthesizer.utils.ascii_table</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.utils.geometry.html">synthesizer.utils.geometry</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.utils.integrate.html">synthesizer.utils.integrate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.utils.plt.html">synthesizer.utils.plt</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.utils.stats.html">synthesizer.utils.stats</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/synthesizer.utils.util_funcs.html">synthesizer.utils.util_funcs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/synthesizer.warnings.html">synthesizer.warnings</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for synthesizer.emission_models.base_model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;A module defining the emission model from which spectra are constructed.</span>

<span class="sd">Generating spectra involves the following steps:</span>
<span class="sd">1. Extraction from a Grid.</span>
<span class="sd">2. Generation of spectra.</span>
<span class="sd">3. Attenuation due to dust in the ISM/nebular.</span>
<span class="sd">4. Masking for different types of emission.</span>
<span class="sd">5. Combination of different types of emission.</span>

<span class="sd">An emission model defines the parameters necessary to perform these steps and</span>
<span class="sd">gives an interface for simply defining the construction of complex spectra.</span>

<span class="sd">Example usage::</span>

<span class="sd">    # Define the grid</span>
<span class="sd">    grid = Grid(...)</span>

<span class="sd">    # Define the dust curve</span>
<span class="sd">    dust_curve = dust.attenuation.PowerLaw(...)</span>

<span class="sd">    # Define the emergent emission model</span>
<span class="sd">    emergent_emission_model = EmissionModel(</span>
<span class="sd">        label=&quot;emergent&quot;,</span>
<span class="sd">        grid=grid,</span>
<span class="sd">        dust_curve=dust_curve,</span>
<span class="sd">        apply_dust_to=dust_emission_model,</span>
<span class="sd">        tau_v=tau_v,</span>
<span class="sd">        fesc=fesc,</span>
<span class="sd">        emitter=&quot;stellar&quot;,</span>
<span class="sd">    )</span>

<span class="sd">    # Generate the spectra</span>
<span class="sd">    spectra = stars.get_spectra(emergent_emission_model)</span>

<span class="sd">    # Generate the lines</span>
<span class="sd">    lines = stars.get_lines(</span>
<span class="sd">        line_ids=(&quot;Ne 4 1601.45A, He 2 1640.41A&quot;, &quot;O3 1660.81A&quot;),</span>
<span class="sd">        emission_model=emergent_emission_model</span>
<span class="sd">    )</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">matplotlib.lines</span> <span class="k">as</span> <span class="nn">mlines</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">unyt</span> <span class="kn">import</span> <span class="n">unyt_quantity</span>

<span class="kn">from</span> <span class="nn">synthesizer</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">synthesizer.emission_models.operations</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Combination</span><span class="p">,</span>
    <span class="n">DustAttenuation</span><span class="p">,</span>
    <span class="n">Extraction</span><span class="p">,</span>
    <span class="n">Generation</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">synthesizer.line</span> <span class="kn">import</span> <span class="n">LineCollection</span>
<span class="kn">from</span> <span class="nn">synthesizer.units</span> <span class="kn">import</span> <span class="n">Quantity</span>
<span class="kn">from</span> <span class="nn">synthesizer.warnings</span> <span class="kn">import</span> <span class="n">warn</span>


<div class="viewcode-block" id="EmissionModel">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel">[docs]</a>
<span class="k">class</span> <span class="nc">EmissionModel</span><span class="p">(</span><span class="n">Extraction</span><span class="p">,</span> <span class="n">Generation</span><span class="p">,</span> <span class="n">DustAttenuation</span><span class="p">,</span> <span class="n">Combination</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to define the construction of a spectra from a grid.</span>

<span class="sd">    An emission model describes the steps necessary to construct a spectra</span>
<span class="sd">    from a grid. These steps can be:</span>
<span class="sd">    - Extracting a spectra from a grid.</span>
<span class="sd">    - Combining multiple spectra.</span>
<span class="sd">    - Applying a dust curve to a spectra.</span>
<span class="sd">    - Generating spectra from a dust emission model.</span>

<span class="sd">    All of these stages can also have masks applied to them to remove certain</span>
<span class="sd">    elements from the spectra (e.g. if you want to eliminate young stars).</span>

<span class="sd">    By chaining together multiple emission models, complex spectra can be</span>
<span class="sd">    constructed from a grid of particles.</span>

<span class="sd">    Note: Every time a property is changed anywhere in the tree the tree must</span>
<span class="sd">    be reconstructed. This is a cheap process but must happen to ensure</span>
<span class="sd">    the expected properties are used when the model is used. This means most</span>
<span class="sd">    attributes are accessed through properties and set via setters to</span>
<span class="sd">    ensure the tree remains consistent.</span>

<span class="sd">    A number of attributes are defined as properties to protect their values</span>
<span class="sd">    and ensure the tree is correctly reconstructed when they are changed.</span>
<span class="sd">    This also means the they are no included below in the Attributes section</span>
<span class="sd">    to avoid duplication.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        label (str):</span>
<span class="sd">            The key for the spectra that will be produced.</span>
<span class="sd">        lam (unyt_array):</span>
<span class="sd">            The wavelength array.</span>
<span class="sd">        masks (list):</span>
<span class="sd">            A list of masks to apply.</span>
<span class="sd">        parents (list):</span>
<span class="sd">            A list of models which depend on this model.</span>
<span class="sd">        children (list):</span>
<span class="sd">            A list of models this model depends on.</span>
<span class="sd">        related_models (list):</span>
<span class="sd">            A list of related models to this model. A related model is a model</span>
<span class="sd">            that is connected somewhere within the model tree but is required</span>
<span class="sd">            in the construction of the &quot;root&quot; model encapulated by self.</span>
<span class="sd">        fixed_parameters (dict):</span>
<span class="sd">            A dictionary of component attributes/parameters which should be</span>
<span class="sd">            fixed and thus ignore the value of the component attribute. This</span>
<span class="sd">            should take the form {&lt;parameter_name&gt;: &lt;value&gt;}.</span>
<span class="sd">        emitter (str):</span>
<span class="sd">            The emitter this emission model acts on. Default is &quot;stellar&quot;.</span>
<span class="sd">        apply_dust_to (EmissionModel):</span>
<span class="sd">            The model to apply the dust curve to.</span>
<span class="sd">        dust_curve (emission_models.attenuation.*):</span>
<span class="sd">            The dust curve to apply.</span>
<span class="sd">        tau_v (float/ndarray/str/tuple):</span>
<span class="sd">            The optical depth to apply. Can be a float, ndarray, or a string</span>
<span class="sd">            to a component attribute. Can also be a tuple combining any of</span>
<span class="sd">            these.</span>
<span class="sd">        generator (EmissionModel):</span>
<span class="sd">            The emission generation model. This must define a get_spectra</span>
<span class="sd">            method.</span>
<span class="sd">        lum_intrinsic_model (EmissionModel):</span>
<span class="sd">            The intrinsic model to use deriving the dust luminosity when</span>
<span class="sd">            computing dust emission.</span>
<span class="sd">        lum_attenuated_model (EmissionModel):</span>
<span class="sd">            The attenuated model to use deriving the dust luminosity when</span>
<span class="sd">            computing dust emission.</span>
<span class="sd">        mask_attr (str):</span>
<span class="sd">            The component attribute to mask on.</span>
<span class="sd">        mask_thresh (unyt_quantity):</span>
<span class="sd">            The threshold for the mask.</span>
<span class="sd">        mask_op (str):</span>
<span class="sd">            The operation to apply. Can be &quot;&lt;&quot;, &quot;&gt;&quot;, &quot;&lt;=&quot;, &quot;&gt;=&quot;, &quot;==&quot;, or &quot;!=&quot;.</span>
<span class="sd">        fesc (float):</span>
<span class="sd">            The escape fraction.</span>
<span class="sd">        scale_by (list):</span>
<span class="sd">            A list of attributes to scale the spectra by.</span>
<span class="sd">        post_processing (list):</span>
<span class="sd">            A list of post processing functions to apply to the emission after</span>
<span class="sd">            it has been generated. Each function must take a dict containing</span>
<span class="sd">            the spectra/lines, the emitters, and the emission model, and return</span>
<span class="sd">            the same dict with the post processing applied.</span>
<span class="sd">        save (bool):</span>
<span class="sd">            A flag for whether the emission produced by this model should be</span>
<span class="sd">            &quot;saved&quot;, i.e. attached to the emitter. If False, the emission will</span>
<span class="sd">            be discarded after it has been used. Default is True.</span>
<span class="sd">        per_particle (bool):</span>
<span class="sd">            A flag for whether the emission produced by this model should be</span>
<span class="sd">            &quot;per particle&quot;. If True, the spectra and lines will be stored per</span>
<span class="sd">            particle. Integrated spectra are made automatically by summing the</span>
<span class="sd">            per particle spectra. Default is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Define quantities</span>
    <span class="n">lam</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">label</span><span class="p">,</span>
        <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extract</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">combine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">apply_dust_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dust_curve</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tau_v</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lum_intrinsic_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lum_attenuated_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_op</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fesc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">related_models</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">emitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fixed_parameters</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">scale_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">post_processing</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">per_particle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the emission model.</span>

<span class="sd">        Each instance of an emission model describes a single step in the</span>
<span class="sd">        process of constructing a spectra. These different steps can be:</span>
<span class="sd">        - Extracting a spectra from a grid. (extract must be set)</span>
<span class="sd">        - Combining multiple spectra. (combine must be set with a list/tuple</span>
<span class="sd">          of child emission models).</span>
<span class="sd">        - Applying a dust curve to the spectra. (dust_curve, apply_dust_to</span>
<span class="sd">          and tau_v must be set)</span>
<span class="sd">        - Generating spectra from a dust emission model. (generator</span>
<span class="sd">          must be set)</span>

<span class="sd">        Within any of these steps a mask can be applied to the spectra to</span>
<span class="sd">        remove certain elements (e.g. if you want to eliminate particles).</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str):</span>
<span class="sd">                The key for the spectra that will be produced.</span>
<span class="sd">            grid (Grid):</span>
<span class="sd">                The grid to extract from.</span>
<span class="sd">            extract (str):</span>
<span class="sd">                The key for the spectra to extract.</span>
<span class="sd">            combine (list):</span>
<span class="sd">                A list of models to combine.</span>
<span class="sd">            apply_dust_to (EmissionModel):</span>
<span class="sd">                The model to apply the dust curve to.</span>
<span class="sd">            dust_curve (emission_models.attenuation.*):</span>
<span class="sd">                The dust curve to apply.</span>
<span class="sd">            tau_v (float/ndarray/str/tuple):</span>
<span class="sd">                The optical depth to apply. Can be a float, ndarray, or a</span>
<span class="sd">                string to a component attribute. Can also be a tuple combining</span>
<span class="sd">                any of these.</span>
<span class="sd">            generator (EmissionModel):</span>
<span class="sd">                The emission generation model. This must define a get_spectra</span>
<span class="sd">                method.</span>
<span class="sd">            lum_intrinsic_model_key (EmissionModel):</span>
<span class="sd">                The intrinsic model to use deriving the dust</span>
<span class="sd">                luminosity when computing dust emission.</span>
<span class="sd">            lum_attenuated_model_key (EmissionModel):</span>
<span class="sd">                The attenuated model to use deriving the dust</span>
<span class="sd">                luminosity when computing dust emission.</span>
<span class="sd">            mask_attr (str):</span>
<span class="sd">                The component attribute to mask on.</span>
<span class="sd">            mask_thresh (unyt_quantity):</span>
<span class="sd">                The threshold for the mask.</span>
<span class="sd">            mask_op (str):</span>
<span class="sd">                The operation to apply. Can be &quot;&lt;&quot;, &quot;&gt;&quot;, &quot;&lt;=&quot;, &quot;&gt;=&quot;, &quot;==&quot;,</span>
<span class="sd">                or &quot;!=&quot;.</span>
<span class="sd">            fesc (float):</span>
<span class="sd">                The escape fraction.</span>
<span class="sd">            related_models (set/list/EmissionModel):</span>
<span class="sd">                A set of related models to this model. A related model is a</span>
<span class="sd">                model that is connected somewhere within the model tree but is</span>
<span class="sd">                required in the construction of the &quot;root&quot; model encapulated by</span>
<span class="sd">                self.</span>
<span class="sd">            emitter (str):</span>
<span class="sd">                The emitter this emission model acts on. Default is</span>
<span class="sd">                &quot;stellar&quot;.</span>
<span class="sd">            fixed_parameters (dict):</span>
<span class="sd">                A dictionary of component attributes/parameters which should be</span>
<span class="sd">                fixed and thus ignore the value of the component attribute.</span>
<span class="sd">                This should take the form {&lt;parameter_name&gt;: &lt;value&gt;}.</span>
<span class="sd">            scale_by (str/list/tuple/EmissionModel):</span>
<span class="sd">                Either a component attribute to scale the resultant spectra by,</span>
<span class="sd">                a spectra key to scale by (based on the bolometric luminosity).</span>
<span class="sd">                or a tuple/list containing strings defining either of the</span>
<span class="sd">                former two options. Instead of a string, an EmissionModel can</span>
<span class="sd">                be passed to scale by the luminosity of that model.</span>
<span class="sd">            post_processing (list):</span>
<span class="sd">                A list of post processing functions to apply to the emission</span>
<span class="sd">                after it has been generated. Each function must take a dict</span>
<span class="sd">                containing the spectra/lines, the emitters, and the emission</span>
<span class="sd">                model, and return the same dict with the post processing</span>
<span class="sd">                applied.</span>
<span class="sd">            save (bool):</span>
<span class="sd">                A flag for whether the emission produced by this model should</span>
<span class="sd">                be &quot;saved&quot;, i.e. attached to the emitter. If False, the</span>
<span class="sd">                emission will be discarded after it has been used. Default is</span>
<span class="sd">                True.</span>
<span class="sd">            per_particle (bool):</span>
<span class="sd">                A flag for whether the emission produced by this model should</span>
<span class="sd">                be &quot;per particle&quot;. If True, the spectra and lines will be</span>
<span class="sd">                stored per particle. Integrated spectra are made automatically</span>
<span class="sd">                by summing the per particle spectra. Default is False.</span>
<span class="sd">            **kwargs:</span>
<span class="sd">                Any additional keyword arguments to store. These can be used</span>
<span class="sd">                to store additional information needed by the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># What is the key for the spectra that will be produced?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

        <span class="c1"># Attach the wavelength array and store it on the model</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lam</span>
        <span class="k">elif</span> <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;lam&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">lam</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Store any extra kwargs this can either be used to store additional</span>
        <span class="c1"># information needed by the model</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Store any fixed parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed_parameters</span> <span class="o">=</span> <span class="n">fixed_parameters</span>

        <span class="c1"># Attach which emitter we are working with</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emitter</span> <span class="o">=</span> <span class="n">emitter</span>

        <span class="c1"># Are we making per particle emission?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_per_particle</span> <span class="o">=</span> <span class="n">per_particle</span>

        <span class="c1"># Define the container which will hold mask information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If we have been given a mask, add it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_masks</span><span class="p">(</span><span class="n">mask_attr</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_op</span><span class="p">)</span>

        <span class="c1"># Get operation flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_operation_flags</span><span class="p">(</span>
            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
            <span class="n">extract</span><span class="o">=</span><span class="n">extract</span><span class="p">,</span>
            <span class="n">combine</span><span class="o">=</span><span class="n">combine</span><span class="p">,</span>
            <span class="n">dust_curve</span><span class="o">=</span><span class="n">dust_curve</span><span class="p">,</span>
            <span class="n">apply_dust_to</span><span class="o">=</span><span class="n">apply_dust_to</span><span class="p">,</span>
            <span class="n">tau_v</span><span class="o">=</span><span class="n">tau_v</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
            <span class="n">lum_intrinsic_model</span><span class="o">=</span><span class="n">lum_intrinsic_model</span><span class="p">,</span>
            <span class="n">lum_attenuated_model</span><span class="o">=</span><span class="n">lum_attenuated_model</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Initilaise the corresponding operation (also checks we have a</span>
        <span class="c1"># valid set of arguments and also have everything we need for the</span>
        <span class="c1"># operation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_operations</span><span class="p">(</span>
            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
            <span class="n">extract</span><span class="o">=</span><span class="n">extract</span><span class="p">,</span>
            <span class="n">combine</span><span class="o">=</span><span class="n">combine</span><span class="p">,</span>
            <span class="n">apply_dust_to</span><span class="o">=</span><span class="n">apply_dust_to</span><span class="p">,</span>
            <span class="n">dust_curve</span><span class="o">=</span><span class="n">dust_curve</span><span class="p">,</span>
            <span class="n">tau_v</span><span class="o">=</span><span class="n">tau_v</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
            <span class="n">lum_intrinsic_model</span><span class="o">=</span><span class="n">lum_intrinsic_model</span><span class="p">,</span>
            <span class="n">lum_attenuated_model</span><span class="o">=</span><span class="n">lum_attenuated_model</span><span class="p">,</span>
            <span class="n">fesc</span><span class="o">=</span><span class="n">fesc</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Containers for children and parents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_children</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Store the arribute to scale the spectra by</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_by</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scale_by</span> <span class="o">=</span> <span class="n">scale_by</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scale_by</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">s</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scale_by</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_by</span><span class="p">,</span> <span class="n">EmissionModel</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scale_by</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale_by</span><span class="o">.</span><span class="n">label</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="n">scale_by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scale_by</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scale_by</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale_by</span><span class="p">,)</span>

        <span class="c1"># Store the post processing functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing</span> <span class="o">=</span> <span class="n">post_processing</span>

        <span class="c1"># Attach the related models</span>
        <span class="k">if</span> <span class="n">related_models</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">related_models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">related_models</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">related_models</span> <span class="o">=</span> <span class="n">related_models</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">related_models</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">related_models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">related_models</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">related_models</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">related_models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">related_models</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">related_models</span><span class="p">,</span> <span class="n">EmissionModel</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">related_models</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">related_models</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;related_models must be a set, list, tuple, or EmissionModel.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Are we saving this emission?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save</span> <span class="o">=</span> <span class="n">save</span>

        <span class="c1"># We&#39;re done with setup, so unpack the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_operations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">grid</span><span class="p">,</span>
        <span class="n">extract</span><span class="p">,</span>
        <span class="n">combine</span><span class="p">,</span>
        <span class="n">apply_dust_to</span><span class="p">,</span>
        <span class="n">dust_curve</span><span class="p">,</span>
        <span class="n">tau_v</span><span class="p">,</span>
        <span class="n">generator</span><span class="p">,</span>
        <span class="n">lum_intrinsic_model</span><span class="p">,</span>
        <span class="n">lum_attenuated_model</span><span class="p">,</span>
        <span class="n">fesc</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the correct parent operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            grid (Grid):</span>
<span class="sd">                The grid to extract from.</span>
<span class="sd">            extract (str):</span>
<span class="sd">                The key for the spectra to extract.</span>
<span class="sd">            combine (list):</span>
<span class="sd">                A list of models to combine.</span>
<span class="sd">            apply_dust_to (EmissionModel):</span>
<span class="sd">                The model to apply the dust curve to.</span>
<span class="sd">            dust_curve (emission_models.attenuation.*):</span>
<span class="sd">                The dust curve to apply.</span>
<span class="sd">            tau_v (float/ndarray/str/tuple):</span>
<span class="sd">                The optical depth to apply. Can be a float, ndarray, or a</span>
<span class="sd">                string to a component attribute. Can also be a tuple combining</span>
<span class="sd">                any of these.</span>
<span class="sd">            generator (EmissionModel):</span>
<span class="sd">                The emission generation model. This must define a get_spectra</span>
<span class="sd">                method.</span>
<span class="sd">            lum_intrinsic_model (EmissionModel):</span>
<span class="sd">                The intrinsic model to use deriving the dust</span>
<span class="sd">                luminosity when computing dust emission.</span>
<span class="sd">            lum_attenuated_model (EmissionModel):</span>
<span class="sd">                The attenuated model to use deriving the dust</span>
<span class="sd">                luminosity when computing dust emission.</span>
<span class="sd">            fesc (float):</span>
<span class="sd">                The escape fraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Which operation are we doing?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span><span class="p">:</span>
            <span class="n">Extraction</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">extract</span><span class="p">,</span> <span class="n">fesc</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_combining</span><span class="p">:</span>
            <span class="n">Combination</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combine</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_attenuating</span><span class="p">:</span>
            <span class="n">DustAttenuation</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dust_curve</span><span class="p">,</span> <span class="n">apply_dust_to</span><span class="p">,</span> <span class="n">tau_v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_emitting</span><span class="p">:</span>
            <span class="n">Generation</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">lum_intrinsic_model</span><span class="p">,</span> <span class="n">lum_attenuated_model</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_generating</span><span class="p">:</span>
            <span class="n">Generation</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">lum_intrinsic_model</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;No valid operation found from the arguments given &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(label=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">). &quot;</span>
                <span class="s2">&quot;Currently have:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">For extraction: grid=(&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_name</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">grid</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; extract=</span><span class="si">{</span><span class="n">extract</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">For combination: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(combine=</span><span class="si">{</span><span class="n">combine</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">For dust attenuation: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(dust_curve=</span><span class="si">{</span><span class="n">dust_curve</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;apply_dust_to=</span><span class="si">{</span><span class="n">apply_dust_to</span><span class="si">}</span><span class="s2"> tau_v=</span><span class="si">{</span><span class="n">tau_v</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">For generation &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(generator=</span><span class="si">{</span><span class="n">generator</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;lum_intrinsic_model=</span><span class="si">{</span><span class="n">lum_intrinsic_model</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;lum_attenuated_model=</span><span class="si">{</span><span class="n">lum_attenuated_model</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Double check we have been asked for only one operation</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_combining</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_attenuating</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_emitting</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_generating</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">!=</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;Can only extract, combine, generate or apply dust to &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;spectra in one model (label=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">). (Attempting to: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;extract: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;combine: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_combining</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;dust_attenuate: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_attenuating</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;dust_emission: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_emitting</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Currently have:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">For extraction: grid=(&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_name</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">grid</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">For combination: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(combine=</span><span class="si">{</span><span class="n">combine</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">For dust attenuation: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(dust_curve=</span><span class="si">{</span><span class="n">dust_curve</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;apply_dust_to=</span><span class="si">{</span><span class="n">apply_dust_to</span><span class="si">}</span><span class="s2"> tau_v=</span><span class="si">{</span><span class="n">tau_v</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">For generation &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(generator=</span><span class="si">{</span><span class="n">generator</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;lum_intrinsic_model=</span><span class="si">{</span><span class="n">lum_intrinsic_model</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;lum_attenuated_model=</span><span class="si">{</span><span class="n">lum_attenuated_model</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Ensure we have what we need for all operations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span> <span class="ow">and</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;Must specify a grid to extract from.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_attenuating</span> <span class="ow">and</span> <span class="n">dust_curve</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;Must specify a dust curve to apply.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_attenuating</span> <span class="ow">and</span> <span class="n">apply_dust_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;Must specify where to apply the dust curve.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_attenuating</span> <span class="ow">and</span> <span class="n">tau_v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;Must specify an optical depth to apply.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Ensure the grid contains any keys we want to extract</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span> <span class="ow">and</span> <span class="n">extract</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Grid does not contain key: </span><span class="si">{</span><span class="n">extract</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_attr</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_op</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the mask operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask_attr (str):</span>
<span class="sd">                The component attribute to mask on.</span>
<span class="sd">            mask_thresh (unyt_quantity):</span>
<span class="sd">                The threshold for the mask.</span>
<span class="sd">            mask_op (str):</span>
<span class="sd">                The operation to apply. Can be &quot;&lt;&quot;, &quot;&gt;&quot;, &quot;&lt;=&quot;, &quot;&gt;=&quot;, &quot;==&quot;,</span>
<span class="sd">                or &quot;!=&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we have been given a mask, add it</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">mask_attr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">mask_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">mask_op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="c1"># Ensure mask_thresh comes with units</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_thresh</span><span class="p">,</span> <span class="n">unyt_quantity</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">MissingUnits</span><span class="p">(</span>
                    <span class="s2">&quot;Mask threshold must be given with units.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;attr&quot;</span><span class="p">:</span> <span class="n">mask_attr</span><span class="p">,</span> <span class="s2">&quot;thresh&quot;</span><span class="p">:</span> <span class="n">mask_thresh</span><span class="p">,</span> <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="n">mask_op</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Ensure we haven&#39;t been given incomplete mask arguments</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mask_attr</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_op</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                    <span class="s2">&quot;For a mask mask_attr, mask_thresh, and mask_op &quot;</span>
                    <span class="s2">&quot;must be passed.&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call the correct summary method.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_summary</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_combining</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_summary</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_attenuating</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attenuate_summary</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_emitting</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_summary</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_generating</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_summary</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string summarising the model.&quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get the labels in reverse order</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract_keys</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_bottom_to_top</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="c1"># Get the model</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

            <span class="c1"># Make the model title</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_emitter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">_emitter</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; (galaxy)&quot;</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>

            <span class="c1"># Get this models summary</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_summary</span><span class="p">())</span>

            <span class="c1"># Report if the resulting emission will be saved</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Save emission: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">_save</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Report if the resulting emission will be per particle</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_per_particle</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  Per particle emission: True&quot;</span><span class="p">)</span>

            <span class="c1"># Print any fixed parameters if there are any</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">fixed_parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  Fixed parameters:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">fixed_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_masked</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  Masks:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
                    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">mask</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mask</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mask</span><span class="p">[</span><span class="s1">&#39;thresh&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Report any attributes we are scaling by</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">scale_by</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  Scaling by:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">scale_by</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_scale_by</span><span class="p">:</span>
                    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">scale_by</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get the length of the longest line</span>
        <span class="n">longest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span>

        <span class="c1"># Place divisions between each model</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">parts</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="n">longest</span>

        <span class="c1"># Pad all lines to the same length</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">longest</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="n">parts</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>

        <span class="c1"># Attach a header and footer line</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot; EmissionModel: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">longest</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">longest</span><span class="p">)</span>

        <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;|&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;|</span><span class="se">\n</span><span class="s2">|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable label look up.</span>

<span class="sd">        Lets us access the models in the tree as if an EmissionModel were a</span>
<span class="sd">        dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The label of the model to get.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">! Model has: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_operation_flags</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extract</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">combine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dust_curve</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">apply_dust_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tau_v</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lum_attenuated_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lum_intrinsic_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the flags for what operation the model does.&quot;&quot;&quot;</span>
        <span class="c1"># Define flags for what we&#39;re doing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span> <span class="o">=</span> <span class="n">extract</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_combining</span> <span class="o">=</span> <span class="n">combine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">combine</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_attenuating</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dust_curve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">apply_dust_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">tau_v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_emitting</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">lum_attenuated_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">lum_intrinsic_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_generating</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_emitting</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_masked</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_unpack_model_recursively</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Traverse the model tree and collect what we will need to do.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (EmissionModel): The model to unpack.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store the model (ensuring the label isn&#39;t already used for a</span>
        <span class="c1"># different model)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="ow">is</span> <span class="n">model</span><span class="p">:</span>
            <span class="c1"># The model is already in the tree so nothing to do</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Label </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2"> is already in use.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># If we are extracting a spectra, store the key</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_extracting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_keys</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">extract</span>

        <span class="c1"># If we are applying a dust curve, store the key</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_dust_attenuating</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dust_attenuation</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">apply_dust_to</span><span class="p">,</span>
                <span class="n">model</span><span class="o">.</span><span class="n">dust_curve</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">apply_dust_to</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">apply_dust_to</span><span class="o">.</span><span class="n">_parents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># If we are applying a dust emission model, store the key</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_generating</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_dust_emitting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generator_models</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generator</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_lum_attenuated_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_lum_attenuated_model</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_lum_attenuated_model</span><span class="o">.</span><span class="n">_parents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_lum_intrinsic_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_lum_intrinsic_model</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_lum_intrinsic_model</span><span class="o">.</span><span class="n">_parents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># If we are masking, store the key</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_masked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mask_keys</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">masks</span>

        <span class="c1"># If we are combining spectra, store the key</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_combining</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_combine_keys</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">combine</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">combine</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="n">child</span><span class="o">.</span><span class="n">_parents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Recurse over children</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_children</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_model_recursively</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="c1"># Collect any related models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">related_models</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">related_models</span><span class="p">)</span>

        <span class="c1"># Populate the top to bottom list but ignoring extraction since</span>
        <span class="c1"># we do the all at once</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_keys</span>
            <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bottom_to_top</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bottom_to_top</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

<div class="viewcode-block" id="EmissionModel.unpack_model">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.unpack_model">[docs]</a>
    <span class="k">def</span> <span class="nf">unpack_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unpack the model tree to get the order of operations.&quot;&quot;&quot;</span>
        <span class="c1"># Define the private containers we&#39;ll unpack everything into. These</span>
        <span class="c1"># are dictionaries of the form {&lt;result_label&gt;: &lt;operation props&gt;}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_keys</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dust_attenuation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generator_models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_combine_keys</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_keys</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Define the list to hold the model labels in order they need to be</span>
        <span class="c1"># generated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bottom_to_top</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Unpack...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_model_recursively</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Also unpack any related models</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_models</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_model_recursively</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Now we&#39;ve worked through the full tree we can set parent pointers</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_children</span><span class="p">:</span>
                <span class="n">child</span><span class="o">.</span><span class="n">_parents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># If we don&#39;t have a wavelength array, find one in the models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">lam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">lam</span>

                <span class="c1"># Ensure the wavelength arrays agree for all models</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">lam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">lam</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                        <span class="s2">&quot;Wavelength arrays do not match somewhere in the tree.&quot;</span>
                    <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_set_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set an attribute on the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            attr (str): The attribute to set.</span>
<span class="sd">            value (Any): The value to set the attribute to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot set attribute </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2"> on model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">. The &quot;</span>
                <span class="s2">&quot;model is not compatible with this attribute.&quot;</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the Grid object used for extraction.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_grid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="EmissionModel.set_grid">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_grid">[docs]</a>
    <span class="k">def</span> <span class="nf">set_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">set_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the grid to extract from.</span>

<span class="sd">        Args:</span>
<span class="sd">            grid (Grid):</span>
<span class="sd">                The grid to extract from.</span>
<span class="sd">            set_all (bool):</span>
<span class="sd">                Whether to set the grid on all models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the grid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_all</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot set a grid on a model that is not extracting.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">set_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span>

        <span class="c1"># Set the wavelength array at the root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lam</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the key for the spectra to extract.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_extract&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="EmissionModel.set_extract">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_extract">[docs]</a>
    <span class="k">def</span> <span class="nf">set_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extract</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the spectra to extract from the grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            extract (str):</span>
<span class="sd">                The key of the spectra to extract.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the extraction key</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extract</span> <span class="o">=</span> <span class="n">extract</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;Cannot set an extraction key on a model that is &quot;</span>
                <span class="s2">&quot;not extracting.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dust_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the dust curve to apply.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_dust_curve&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">apply_dust_to</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the spectra to apply the dust curve to.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_apply_dust_to&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tau_v</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the optical depth to apply.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_tau_v&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="EmissionModel.set_dust_props">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_dust_props">[docs]</a>
    <span class="k">def</span> <span class="nf">set_dust_props</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dust_curve</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">apply_dust_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tau_v</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">set_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the dust attenuation properties on this model.</span>

<span class="sd">        Args:</span>
<span class="sd">            dust_curve (emission_models.attenuation.*):</span>
<span class="sd">                A dust curve instance to apply.</span>
<span class="sd">            apply_dust_to (EmissionModel):</span>
<span class="sd">                The model to apply the dust curve to.</span>
<span class="sd">            tau_v (float/ndarray/str/tuple):</span>
<span class="sd">                The optical depth to apply. Can be a float, ndarray, or a</span>
<span class="sd">                string to a component attribute. Can also be a tuple combining</span>
<span class="sd">                any of these. If a tuple then the eventual tau_v will be the</span>
<span class="sd">                product of all contributors.</span>
<span class="sd">            set_all (bool):</span>
<span class="sd">                Whether to set the properties on all models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the properties</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_all</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_attenuating</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dust_curve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr</span><span class="p">(</span><span class="s2">&quot;dust_curve&quot;</span><span class="p">,</span> <span class="n">dust_curve</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">apply_dust_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr</span><span class="p">(</span><span class="s2">&quot;apply_dust_to&quot;</span><span class="p">,</span> <span class="n">apply_dust_to</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tau_v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr</span><span class="p">(</span>
                        <span class="s2">&quot;tau_v&quot;</span><span class="p">,</span>
                        <span class="n">tau_v</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tau_v</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="p">[</span><span class="n">tau_v</span><span class="p">],</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot set dust attenuation properties on a model that &quot;</span>
                    <span class="s2">&quot;is not dust attenuating.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dust_attenuating</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">set_dust_props</span><span class="p">(</span>
                        <span class="n">dust_curve</span><span class="o">=</span><span class="n">dust_curve</span><span class="p">,</span>
                        <span class="n">apply_dust_to</span><span class="o">=</span><span class="n">apply_dust_to</span><span class="p">,</span>
                        <span class="n">tau_v</span><span class="o">=</span><span class="n">tau_v</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the emission generation model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_generator&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="EmissionModel.set_generator">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_generator">[docs]</a>
    <span class="k">def</span> <span class="nf">set_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the dust emission model on this model.</span>

<span class="sd">        Args:</span>
<span class="sd">            generator (EmissionModel):</span>
<span class="sd">                The emission generation model to set.</span>
<span class="sd">            label (str):</span>
<span class="sd">                The label of the model to set the dust emission model on. If</span>
<span class="sd">                None, sets the dust emission model on this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure model is a emission generation model and change the model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">_is_dust_emitting</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">_is_generating</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr</span><span class="p">(</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;Cannot set a dust emission model on a model that is not &quot;</span>
                <span class="s2">&quot;dust emitting.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">emitter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the emitter this emission model acts on.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_emitter&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="EmissionModel.set_emitter">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_emitter">[docs]</a>
    <span class="k">def</span> <span class="nf">set_emitter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emitter</span><span class="p">,</span> <span class="n">set_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the emitter this emission model acts on.</span>

<span class="sd">        Args:</span>
<span class="sd">            emitter (str):</span>
<span class="sd">                The emitter this emission model acts on.</span>
<span class="sd">            set_all (bool):</span>
<span class="sd">                Whether to set the emitter on all models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the emitter</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_all</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr</span><span class="p">(</span><span class="s2">&quot;emitter&quot;</span><span class="p">,</span> <span class="n">emitter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">model</span><span class="o">.</span><span class="n">set_emitter</span><span class="p">(</span><span class="n">emitter</span><span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">per_particle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the per particle flag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_per_particle</span>

<div class="viewcode-block" id="EmissionModel.set_per_particle">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_per_particle">[docs]</a>
    <span class="k">def</span> <span class="nf">set_per_particle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">per_particle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the per particle flag.</span>

<span class="sd">        For per particle spectra we need all children to also be per particle.</span>

<span class="sd">        Args:</span>
<span class="sd">            per_particle (bool):</span>
<span class="sd">                Whether to set the per particle flag.</span>
<span class="sd">            set_all (bool):</span>
<span class="sd">                Whether to set the per particle flag on all models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the per particle flag (but we don&#39;t want to set it on a</span>
        <span class="c1"># galaxy model since they are never per particle by definition)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">emitter</span> <span class="o">!=</span> <span class="s2">&quot;galaxy&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_per_particle</span> <span class="o">=</span> <span class="n">per_particle</span>

        <span class="c1"># Set the per particle flag on all children</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">set_per_particle</span><span class="p">(</span><span class="n">per_particle</span><span class="p">)</span>

        <span class="c1"># If this model also has related spectra we&#39;d better make those</span>
        <span class="c1"># per particle too or bad things will happen downstream</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_models</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">set_per_particle</span><span class="p">(</span><span class="n">per_particle</span><span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lum_intrinsic_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the intrinsic model for computing dust luminosity.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_lum_intrinsic_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="EmissionModel.set_lum_intrinsic_model">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_lum_intrinsic_model">[docs]</a>
    <span class="k">def</span> <span class="nf">set_lum_intrinsic_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lum_intrinsic_model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the intrinsic model for computing dust luminosity.</span>

<span class="sd">        Args:</span>
<span class="sd">            lum_intrinsic_model (EmissionModel):</span>
<span class="sd">                The intrinsic model to set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure model is a emission generation model and change the model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">_is_dust_emitting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr</span><span class="p">(</span><span class="s2">&quot;lum_intrinsic_model&quot;</span><span class="p">,</span> <span class="n">lum_intrinsic_model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;Cannot set an intrinsic model on a model that is not &quot;</span>
                <span class="s2">&quot;dust emitting.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lum_attenuated_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the attenuated model for computing dust luminosity.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_lum_attenuated_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="EmissionModel.set_lum_attenuated_model">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_lum_attenuated_model">[docs]</a>
    <span class="k">def</span> <span class="nf">set_lum_attenuated_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lum_attenuated_model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the attenuated model for computing dust luminosity.</span>

<span class="sd">        Args:</span>
<span class="sd">            lum_attenuated_model (EmissionModel):</span>
<span class="sd">                The attenuated model to set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure model is a emission generation model and change the model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">_is_dust_emitting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr</span><span class="p">(</span><span class="s2">&quot;lum_attenuated_model&quot;</span><span class="p">,</span> <span class="n">lum_attenuated_model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;Cannot set an attenuated model on a model that is not &quot;</span>
                <span class="s2">&quot;dust emitting.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the models to combine.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_combine&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">())</span>

<div class="viewcode-block" id="EmissionModel.set_combine">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_combine">[docs]</a>
    <span class="k">def</span> <span class="nf">set_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combine</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the models to combine on this model.</span>

<span class="sd">        Args:</span>
<span class="sd">            combine (list):</span>
<span class="sd">                A list of models to combine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure all models are EmissionModels</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">combine</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">EmissionModel</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                    <span class="s2">&quot;All models to combine must be EmissionModels.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Set the models to combine ensurign the model we are setting on is</span>
        <span class="c1"># a combination step</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_combining</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span> <span class="o">=</span> <span class="n">combine</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;Cannot set models to combine on a model that is not &quot;</span>
                <span class="s2">&quot;combining.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fesc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the escape fraction.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_fesc&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

<div class="viewcode-block" id="EmissionModel.set_fesc">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_fesc">[docs]</a>
    <span class="k">def</span> <span class="nf">set_fesc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fesc</span><span class="p">,</span> <span class="n">set_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the escape fraction on this model.</span>

<span class="sd">        Args:</span>
<span class="sd">            fesc (float):</span>
<span class="sd">                The escape fraction to set.</span>
<span class="sd">            set_all (bool):</span>
<span class="sd">                Whether to set the escape fraction on all models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the escape fraction</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_all</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fesc</span> <span class="o">=</span> <span class="n">fesc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot set an escape fraction on a model that is not &quot;</span>
                    <span class="s2">&quot;extracting.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_extracting</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_generating</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">set_fesc</span><span class="p">(</span><span class="n">fesc</span><span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scale_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the attribute to scale the spectra by.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_by</span>

<div class="viewcode-block" id="EmissionModel.set_scale_by">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_scale_by">[docs]</a>
    <span class="k">def</span> <span class="nf">set_scale_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale_by</span><span class="p">,</span> <span class="n">set_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the attribute to scale the spectra by.</span>

<span class="sd">        Args:</span>
<span class="sd">            scale_by (str/list/tuple/EmissionModel):</span>
<span class="sd">                Either a component attribute to scale the resultant spectra by,</span>
<span class="sd">                a spectra key to scale by (based on the bolometric luminosity).</span>
<span class="sd">                or a tuple/list containing strings defining either of the</span>
<span class="sd">                former two options. Instead of a string, an EmissionModel can</span>
<span class="sd">                be passed to scale by the luminosity of that model.</span>
<span class="sd">            set_all (bool):</span>
<span class="sd">                Whether to set the scale by attribute on all models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the attribute to scale by</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_all</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_by</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scale_by</span> <span class="o">=</span> <span class="n">scale_by</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scale_by</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">s</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scale_by</span>
                <span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_by</span><span class="p">,</span> <span class="n">EmissionModel</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scale_by</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale_by</span><span class="o">.</span><span class="n">label</span><span class="p">,)</span>
            <span class="k">elif</span> <span class="n">scale_by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scale_by</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scale_by</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale_by</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">model</span><span class="o">.</span><span class="n">set_scale_by</span><span class="p">(</span><span class="n">scale_by</span><span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">post_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the post processing functions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_post_processing&quot;</span><span class="p">,</span> <span class="p">[])</span>

<div class="viewcode-block" id="EmissionModel.set_post_processing">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_post_processing">[docs]</a>
    <span class="k">def</span> <span class="nf">set_post_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_processing</span><span class="p">,</span> <span class="n">set_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the post processing functions on this model.</span>

<span class="sd">        Args:</span>
<span class="sd">            post_processing (list):</span>
<span class="sd">                A list of post processing functions to apply to the emission</span>
<span class="sd">                after it has been generated. Each function must take a dict</span>
<span class="sd">                containing the spectra/lines and return the same dict with the</span>
<span class="sd">                post processing applied.</span>
<span class="sd">            set_all (bool):</span>
<span class="sd">                Whether to set the post processing functions on all models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the post processing functions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_all</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_post_processing</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">post_processing</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_post_processing</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">model</span><span class="o">.</span><span class="n">set_post_processing</span><span class="p">(</span><span class="n">post_processing</span><span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the flag for whether to save the emission.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_save&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="EmissionModel.set_save">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.set_save">[docs]</a>
    <span class="k">def</span> <span class="nf">set_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">set_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the flag for whether to save the emission.</span>

<span class="sd">        Args:</span>
<span class="sd">            save (bool):</span>
<span class="sd">                Whether to save the emission.</span>
<span class="sd">            set_all (bool):</span>
<span class="sd">                Whether to set the save flag on all models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the save flag</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_all</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save</span> <span class="o">=</span> <span class="n">save</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">model</span><span class="o">.</span><span class="n">set_save</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>

        <span class="c1"># Unpack the model now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


<div class="viewcode-block" id="EmissionModel.save_spectra">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.save_spectra">[docs]</a>
    <span class="k">def</span> <span class="nf">save_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the save flag to True for the given spectra.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (str):</span>
<span class="sd">                The spectra to save.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First set all models to not save</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_save</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">set_all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Now set the given spectra to save</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">set_save</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmissionModel.add_mask">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.add_mask">[docs]</a>
    <span class="k">def</span> <span class="nf">add_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">set_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a mask.</span>

<span class="sd">        Args:</span>
<span class="sd">            attr (str):</span>
<span class="sd">                The component attribute to mask on.</span>
<span class="sd">            op (str):</span>
<span class="sd">                The operation to apply. Can be &quot;&lt;&quot;, &quot;&gt;&quot;, &quot;&lt;=&quot;, &quot;&gt;=&quot;, &quot;==&quot;,</span>
<span class="sd">                or &quot;!=&quot;.</span>
<span class="sd">            thresh (unyt_quantity):</span>
<span class="sd">                The threshold for the mask.</span>
<span class="sd">            set_all (bool):</span>
<span class="sd">                Whether to add the mask to all models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure we have units</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thresh</span><span class="p">,</span> <span class="n">unyt_quantity</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">MissingUnits</span><span class="p">(</span>
                <span class="s2">&quot;Mask threshold must be given with units.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Ensure operation is valid</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;Invalid mask operation. Must be one of: &lt;, &gt;, &lt;=, &gt;=&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Add the mask</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_all</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;attr&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s2">&quot;thresh&quot;</span><span class="p">:</span> <span class="n">thresh</span><span class="p">,</span> <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="n">op</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_masked</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">model</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;attr&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s2">&quot;thresh&quot;</span><span class="p">:</span> <span class="n">thresh</span><span class="p">,</span> <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="n">op</span><span class="p">})</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_is_masked</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Unpack now that we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


<div class="viewcode-block" id="EmissionModel.replace_model">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.replace_model">[docs]</a>
    <span class="k">def</span> <span class="nf">replace_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replace_label</span><span class="p">,</span> <span class="o">*</span><span class="n">replacements</span><span class="p">,</span> <span class="n">new_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a child model from this model.</span>

<span class="sd">        Args:</span>
<span class="sd">            replace_label (str):</span>
<span class="sd">                The label of the model to replace.</span>
<span class="sd">            replacements (EmissionModel):</span>
<span class="sd">                The models to replace the model with.</span>
<span class="sd">            new_label (str):</span>
<span class="sd">                The label for the new combination step if multiple replacements</span>
<span class="sd">                have been passed (ignored otherwise).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure the label exists</span>
        <span class="k">if</span> <span class="n">replace_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find a model with the label: </span><span class="si">{</span><span class="n">replace_label</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Ensure all replacements are EmissionModels</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">EmissionModel</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                    <span class="s2">&quot;All replacements must be EmissionModels.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Get the model we are replacing</span>
        <span class="n">replace_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">replace_label</span><span class="p">]</span>

        <span class="c1"># Get the children and parents of this model</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="n">replace_model</span><span class="o">.</span><span class="n">_parents</span>
        <span class="n">children</span> <span class="o">=</span> <span class="n">replace_model</span><span class="o">.</span><span class="n">_children</span>

        <span class="c1"># Define the relation to all parents and children</span>
        <span class="n">relations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">replace_model</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">combine</span><span class="p">:</span>
                <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;combine&quot;</span>
            <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">apply_dust_to</span> <span class="o">==</span> <span class="n">replace_model</span><span class="p">:</span>
                <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dust_attenuate&quot;</span>
            <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lum_intrinsic_model</span> <span class="o">==</span> <span class="n">replace_model</span><span class="p">:</span>
                <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dust_intrinsic&quot;</span>
            <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lum_attenuated_model</span> <span class="o">==</span> <span class="n">replace_model</span><span class="p">:</span>
                <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dust_attenuated&quot;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">replace_model</span><span class="o">.</span><span class="n">combine</span><span class="p">:</span>
                <span class="n">relations</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;combine&quot;</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">apply_dust_to</span> <span class="o">==</span> <span class="n">replace_model</span><span class="p">:</span>
                <span class="n">relations</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dust_attenuate&quot;</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">lum_intrinsic_model</span> <span class="o">==</span> <span class="n">replace_model</span><span class="p">:</span>
                <span class="n">relations</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dust_intrinsic&quot;</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">lum_attenuated_model</span> <span class="o">==</span> <span class="n">replace_model</span><span class="p">:</span>
                <span class="n">relations</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dust_attenuated&quot;</span>

        <span class="c1"># Remove the model we are replacing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">replace_label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">replace_model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;combine&quot;</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">_combine</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">replace_model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dust_attenuate&quot;</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">_apply_dust_to</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dust_intrinsic&quot;</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">_lum_intrinsic_model</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dust_attenuated&quot;</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">_lum_attenuated_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">_parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">replace_model</span><span class="p">)</span>

        <span class="c1"># Do we have more than 1 replacement?</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">replacements</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># We&#39;ll have to include a combination model</span>
            <span class="n">new_model</span> <span class="o">=</span> <span class="n">EmissionModel</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="n">replace_label</span> <span class="k">if</span> <span class="n">new_label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">new_label</span><span class="p">,</span>
                <span class="n">combine</span><span class="o">=</span><span class="n">replacements</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emitter</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_model</span> <span class="o">=</span> <span class="n">replacements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Warn the user if they passed a new label, it won&#39;t be used</span>
            <span class="k">if</span> <span class="n">new_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;new_label is only used when multiple &quot;</span>
                    <span class="s2">&quot;replacements are passed.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Attach the new model/s to the children</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">_parents</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">replacements</span><span class="p">))</span>

        <span class="c1"># Attach the new model to the parents</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;combine&quot;</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dust_attenuate&quot;</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">_apply_dust_to</span> <span class="o">=</span> <span class="n">new_model</span>
            <span class="k">if</span> <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dust_intrinsic&quot;</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">_lum_intrinsic_model</span> <span class="o">=</span> <span class="n">new_model</span>
            <span class="k">if</span> <span class="n">relations</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dust_attenuated&quot;</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">_lum_attenuated_model</span> <span class="o">=</span> <span class="n">new_model</span>

        <span class="c1"># Unpack now we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_model</span><span class="p">()</span></div>


<div class="viewcode-block" id="EmissionModel.relabel">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.relabel">[docs]</a>
    <span class="k">def</span> <span class="nf">relabel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_label</span><span class="p">,</span> <span class="n">new_label</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the label associated to an existing spectra.</span>

<span class="sd">        Args:</span>
<span class="sd">            old_label (str): The current label of the spectra.</span>
<span class="sd">            new_label (str): The new label to assign to the spectra.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure the new label is not already in use</span>
        <span class="k">if</span> <span class="n">new_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Label </span><span class="si">{</span><span class="n">new_label</span><span class="si">}</span><span class="s2"> is already in use.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Ensure the old label is in use</span>
        <span class="k">if</span> <span class="n">old_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Label </span><span class="si">{</span><span class="n">old_label</span><span class="si">}</span><span class="s2"> is not in use.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get the model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">old_label</span><span class="p">]</span>

        <span class="c1"># Update the label</span>
        <span class="n">model</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">new_label</span>

        <span class="c1"># Update the models dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">new_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">old_label</span><span class="p">]</span></div>


<div class="viewcode-block" id="EmissionModel.fix_parameters">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.fix_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">fix_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fix parameters of the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs:</span>
<span class="sd">                The parameters to fix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_tree_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the levels of the tree.</span>

<span class="sd">        Args:</span>
<span class="sd">            root (str):</span>
<span class="sd">                The root of the tree to get the levels for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            levels (dict):</span>
<span class="sd">                The levels of the models in the tree.</span>
<span class="sd">            links (dict):</span>
<span class="sd">                The links between models.</span>
<span class="sd">            extract_labels (set):</span>
<span class="sd">                The labels of models that are extracting.</span>
<span class="sd">            masked_labels (list):</span>
<span class="sd">                The labels of models that are masked.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_assign_levels</span><span class="p">(</span>
            <span class="n">levels</span><span class="p">,</span>
            <span class="n">links</span><span class="p">,</span>
            <span class="n">extract_labels</span><span class="p">,</span>
            <span class="n">masked_labels</span><span class="p">,</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">level</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Recursively assign levels to the models.</span>

<span class="sd">            Args:</span>
<span class="sd">                levels (dict):</span>
<span class="sd">                    The levels of the models.</span>
<span class="sd">                links (dict):</span>
<span class="sd">                    The links between models.</span>
<span class="sd">                extract_labels (set):</span>
<span class="sd">                    The labels of models that are extracting.</span>
<span class="sd">                masked_labels (list):</span>
<span class="sd">                    The labels of models that are masked.</span>
<span class="sd">                components (dict):</span>
<span class="sd">                    The component each model acts on.</span>
<span class="sd">                model (EmissionModel):</span>
<span class="sd">                    The model to assign the level to.</span>
<span class="sd">                level (int):</span>
<span class="sd">                    The level to assign to the model.</span>

<span class="sd">            Returns:</span>
<span class="sd">                levels (dict):</span>
<span class="sd">                    The levels of the models.</span>
<span class="sd">                links (dict):</span>
<span class="sd">                    The links between models.</span>
<span class="sd">                extract_labels (set):</span>
<span class="sd">                    The labels of models that are extracting.</span>
<span class="sd">                masked_labels (list):</span>
<span class="sd">                    The labels of models that are masked.</span>
<span class="sd">                components (dict):</span>
<span class="sd">                    The component each model acts on.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Get the model label</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">label</span>

            <span class="c1"># Assign the level</span>
            <span class="n">levels</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">levels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">level</span><span class="p">),</span> <span class="n">level</span><span class="p">)</span>

            <span class="c1"># Define the links</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_dust_attenuating</span><span class="p">:</span>
                <span class="n">links</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">apply_dust_to</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_combining</span><span class="p">:</span>
                <span class="n">links</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[(</span><span class="n">child</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_combine</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_dust_emitting</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_generating</span><span class="p">:</span>
                <span class="n">links</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">_lum_intrinsic_model</span><span class="o">.</span><span class="n">label</span>
                            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_lum_intrinsic_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;dotted&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="p">(</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">_lum_attenuated_model</span><span class="o">.</span><span class="n">label</span>
                            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_lum_attenuated_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;dotted&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_masked</span><span class="p">:</span>
                <span class="n">masked_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_is_extracting</span><span class="p">:</span>
                <span class="n">extract_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="c1"># Recurse</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_children</span><span class="p">:</span>
                <span class="p">(</span>
                    <span class="n">levels</span><span class="p">,</span>
                    <span class="n">links</span><span class="p">,</span>
                    <span class="n">extract_labels</span><span class="p">,</span>
                    <span class="n">masked_labels</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">_assign_levels</span><span class="p">(</span>
                    <span class="n">levels</span><span class="p">,</span>
                    <span class="n">links</span><span class="p">,</span>
                    <span class="n">extract_labels</span><span class="p">,</span>
                    <span class="n">masked_labels</span><span class="p">,</span>
                    <span class="n">child</span><span class="p">,</span>
                    <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">levels</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">extract_labels</span><span class="p">,</span> <span class="n">masked_labels</span>

        <span class="c1"># Get the root model</span>
        <span class="n">root_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">root</span><span class="p">]</span>

        <span class="c1"># Recursively assign levels</span>
        <span class="p">(</span>
            <span class="n">model_levels</span><span class="p">,</span>
            <span class="n">links</span><span class="p">,</span>
            <span class="n">extract_labels</span><span class="p">,</span>
            <span class="n">masked_labels</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">_assign_levels</span><span class="p">({},</span> <span class="p">{},</span> <span class="nb">set</span><span class="p">(),</span> <span class="p">[],</span> <span class="n">root_model</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Unpack the levels</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">model_levels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">levels</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">levels</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">extract_labels</span><span class="p">,</span> <span class="n">masked_labels</span>

    <span class="k">def</span> <span class="nf">_get_model_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">ychunk</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">xchunk</span><span class="o">=</span><span class="mf">20.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the position of each model in the tree.</span>

<span class="sd">        Args:</span>
<span class="sd">            levels (dict):</span>
<span class="sd">                The levels of the models in the tree.</span>
<span class="sd">            ychunk (float):</span>
<span class="sd">                The vertical spacing between levels.</span>
<span class="sd">            xchunk (float):</span>
<span class="sd">                The horizontal spacing between models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pos (dict):</span>
<span class="sd">                The position of each model in the tree.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_get_parent_pos</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get the position of the parent/s of a model.</span>

<span class="sd">            Args:</span>
<span class="sd">                pos (dict):</span>
<span class="sd">                    The position of each model in the tree.</span>
<span class="sd">                model (EmissionModel):</span>
<span class="sd">                    The model to get the parent position for.</span>

<span class="sd">            Returns:</span>
<span class="sd">                x (float):</span>
<span class="sd">                    The x position of the parent.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Get the parents</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">label</span>
                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_parents</span>
                <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">pos</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">parents</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">parents</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pos</span><span class="p">[</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">parents</span><span class="p">)])</span>

        <span class="k">def</span> <span class="nf">_get_child_pos</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">xchunk</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get the position of the children of a model.</span>

<span class="sd">            Args:</span>
<span class="sd">                x (float):</span>
<span class="sd">                    The x position of the parent.</span>
<span class="sd">                pos (dict):</span>
<span class="sd">                    The position of each model in the tree.</span>
<span class="sd">                children (list):</span>
<span class="sd">                    The children of the model.</span>
<span class="sd">                level (int):</span>
<span class="sd">                    The level of the children.</span>
<span class="sd">                xchunk (float):</span>
<span class="sd">                    The horizontal spacing between models.</span>

<span class="sd">            Returns:</span>
<span class="sd">                pos (dict):</span>
<span class="sd">                    The position of each model in the tree.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Get the start x</span>
            <span class="n">start_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">xchunk</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_x</span><span class="p">,</span> <span class="n">level</span> <span class="o">*</span> <span class="n">ychunk</span><span class="p">)</span>
                <span class="n">start_x</span> <span class="o">+=</span> <span class="n">xchunk</span>
            <span class="k">return</span> <span class="n">pos</span>

        <span class="k">def</span> <span class="nf">_get_level_pos</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">xchunk</span><span class="p">,</span> <span class="n">ychunk</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get the position of the models in a level.</span>

<span class="sd">            Args:</span>
<span class="sd">                pos (dict):</span>
<span class="sd">                    The position of each model in the tree.</span>
<span class="sd">                level (int):</span>
<span class="sd">                    The level to get the position for.</span>
<span class="sd">                levels (dict):</span>
<span class="sd">                    The levels of the models in the tree.</span>
<span class="sd">                xchunk (float):</span>
<span class="sd">                    The horizontal spacing between models.</span>
<span class="sd">                ychunk (float):</span>
<span class="sd">                    The vertical spacing between levels.</span>

<span class="sd">            Returns:</span>
<span class="sd">                pos (dict):</span>
<span class="sd">                    The position of each model in the tree.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Get the models in this level</span>
            <span class="n">models</span> <span class="o">=</span> <span class="n">levels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="p">[])</span>

            <span class="c1"># Get the position of the parents</span>
            <span class="n">parent_pos</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_get_parent_pos</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">model</span><span class="p">])</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span>
            <span class="p">]</span>

            <span class="c1"># Sort models by parent_pos</span>
            <span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">model</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">parent_pos</span><span class="p">,</span> <span class="n">models</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">]</span>

            <span class="c1"># Get the parents</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                <span class="n">parents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">parent</span><span class="o">.</span><span class="n">label</span>
                        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">_parents</span>
                        <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">pos</span>
                    <span class="p">]</span>
                <span class="p">)</span>

            <span class="c1"># If we only have one parent for this level then we can assign</span>
            <span class="c1"># the position based on the parent</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">parents</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">_get_parent_pos</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">_get_child_pos</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">xchunk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get the position of the first model</span>
                <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">xchunk</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

                <span class="c1"># Assign the positions</span>
                <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                    <span class="n">pos</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">level</span> <span class="o">*</span> <span class="n">ychunk</span><span class="p">)</span>
                    <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">+=</span> <span class="n">xchunk</span>

            <span class="c1"># Recurse</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">_get_level_pos</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">xchunk</span><span class="p">,</span> <span class="n">ychunk</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">pos</span>

        <span class="k">return</span> <span class="n">_get_level_pos</span><span class="p">({</span><span class="n">root</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)},</span> <span class="mi">1</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">xchunk</span><span class="p">,</span> <span class="n">ychunk</span><span class="p">)</span>

<div class="viewcode-block" id="EmissionModel.plot_emission_tree">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.EmissionModel.plot_emission_tree">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_emission_tree</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the tree defining the spectra.</span>

<span class="sd">        Args:</span>
<span class="sd">            root (str):</span>
<span class="sd">                If not None this defines the root of a sub tree to plot.</span>
<span class="sd">            show (bool):</span>
<span class="sd">                Whether to show the plot.</span>
<span class="sd">            fontsize (int):</span>
<span class="sd">                The fontsize to use for the labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the tree levels</span>
        <span class="n">levels</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">extract_labels</span><span class="p">,</span> <span class="n">masked_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tree_levels</span><span class="p">(</span>
            <span class="n">root</span> <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="p">)</span>

        <span class="c1"># Get the postion of each node</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_positions</span><span class="p">(</span>
            <span class="n">levels</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root</span> <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="p">)</span>

        <span class="c1"># Keep track of which components are included</span>
        <span class="n">components</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># We need a flag for the for whether any models are discarded so we</span>
        <span class="c1"># know whether to include it in the legend</span>
        <span class="n">some_discarded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Define a flag for whether there are per_particle models</span>
        <span class="n">some_per_particle</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Plot the tree using Matplotlib</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="c1"># Draw nodes with different styles if they are masked</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">components</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">emitter</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">emitter</span> <span class="o">==</span> <span class="s2">&quot;stellar&quot;</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;gold&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">emitter</span> <span class="o">==</span> <span class="s2">&quot;blackhole&quot;</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;royalblue&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;forestgreen&quot;</span>

            <span class="c1"># If the model isn&#39;t saved apply some transparency</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span>
                <span class="n">some_discarded</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="o">-</span><span class="n">y</span><span class="p">,</span>  <span class="c1"># Invert y-axis for bottom-to-top</span>
                <span class="n">node</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extract_labels</span>
                    <span class="k">else</span> <span class="s2">&quot;square,pad=0.5&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># If we have a per particle model overlay a hatched box. To make]</span>
            <span class="c1"># this readable we need to overlay a box with a transparent face</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">per_particle</span><span class="p">:</span>
                <span class="n">some_per_particle</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span>
                    <span class="o">-</span><span class="n">y</span><span class="p">,</span>  <span class="c1"># Invert y-axis for bottom-to-top</span>
                    <span class="n">node</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                        <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span>
                        <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extract_labels</span>
                        <span class="k">else</span> <span class="s2">&quot;square,pad=0.5&quot;</span><span class="p">,</span>
                        <span class="n">hatch</span><span class="o">=</span><span class="s2">&quot;//&quot;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Used a dashed outline for masked nodes</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_bbox_patch</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">masked_labels</span><span class="p">:</span>
                <span class="n">bbox</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">(</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>

        <span class="c1"># Draw edges with different styles based on link type</span>
        <span class="n">linestyles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">linestyle</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pos</span> <span class="ow">or</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">linestyles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">linestyle</span><span class="p">)</span>
                <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
                <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">sx</span><span class="p">,</span> <span class="n">tx</span><span class="p">],</span>
                    <span class="p">[</span><span class="o">-</span><span class="n">sy</span><span class="p">,</span> <span class="o">-</span><span class="n">ty</span><span class="p">],</span>  <span class="c1"># Invert y-axis for bottom-to-top</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Create legend elements</span>
        <span class="n">handles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;--&quot;</span> <span class="ow">in</span> <span class="n">linestyles</span><span class="p">:</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
                    <span class="p">[],</span>
                    <span class="p">[],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Attenuated&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">linestyles</span><span class="p">:</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
                    <span class="p">[],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Combined&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;dotted&quot;</span> <span class="ow">in</span> <span class="n">linestyles</span><span class="p">:</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
                    <span class="p">[],</span>
                    <span class="p">[],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Dust Luminosity&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Include a component legend element</span>
        <span class="k">if</span> <span class="s2">&quot;stellar&quot;</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mpatches</span><span class="o">.</span><span class="n">FancyBboxPatch</span><span class="p">(</span>
                    <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">height</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;gold&quot;</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stellar&quot;</span><span class="p">,</span>
                    <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;blackhole&quot;</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mpatches</span><span class="o">.</span><span class="n">FancyBboxPatch</span><span class="p">(</span>
                    <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">height</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Black Hole&quot;</span><span class="p">,</span>
                    <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;galaxy&quot;</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mpatches</span><span class="o">.</span><span class="n">FancyBboxPatch</span><span class="p">(</span>
                    <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">height</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Galaxy&quot;</span><span class="p">,</span>
                    <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Include a masked legend element if we have masked nodes</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">masked_labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mpatches</span><span class="o">.</span><span class="n">FancyBboxPatch</span><span class="p">(</span>
                    <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">height</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Masked&quot;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span>
                    <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Include a transparent legend element for non-saved nodes if needed</span>
        <span class="k">if</span> <span class="n">some_discarded</span><span class="p">:</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mpatches</span><span class="o">.</span><span class="n">FancyBboxPatch</span><span class="p">(</span>
                    <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">height</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Saved&quot;</span><span class="p">,</span>
                    <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mpatches</span><span class="o">.</span><span class="n">FancyBboxPatch</span><span class="p">(</span>
                    <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">height</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Discarded&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                    <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># If we have per particle models include them in the legend</span>
        <span class="k">if</span> <span class="n">some_per_particle</span><span class="p">:</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mpatches</span><span class="o">.</span><span class="n">FancyBboxPatch</span><span class="p">(</span>
                    <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">height</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Per Particle&quot;</span><span class="p">,</span>
                    <span class="n">hatch</span><span class="o">=</span><span class="s2">&quot;//&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Add legend to the bottom of the plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">,</span>
            <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
            <span class="n">ncol</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>


    <span class="k">def</span> <span class="nf">_apply_overrides</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">emission_model</span><span class="p">,</span> <span class="n">dust_curves</span><span class="p">,</span> <span class="n">tau_v</span><span class="p">,</span> <span class="n">fesc</span><span class="p">,</span> <span class="n">covering_fraction</span><span class="p">,</span> <span class="n">mask</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply overrides to an emission model copy.</span>

<span class="sd">        This function is used in _get_spectra to apply any emission model</span>
<span class="sd">        property overrides passed to that method before generating the</span>
<span class="sd">        spectra.</span>

<span class="sd">        _get_spectra will make a copy of the emission model and then pass it</span>
<span class="sd">        to this function to apply any overrides before generating the spectra.</span>

<span class="sd">        Args:</span>
<span class="sd">            emission_model (EmissionModel):</span>
<span class="sd">                The emission model copy to apply the overrides to.</span>
<span class="sd">            dust_curves (dict):</span>
<span class="sd">                An overide to the emission model dust curves. Either:</span>
<span class="sd">                    - None, indicating the dust_curves defined on the emission</span>
<span class="sd">                      models should be used.</span>
<span class="sd">                    - A single dust curve to apply to all emission models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                          {&lt;label&gt;: &lt;dust_curve instance&gt;}</span>
<span class="sd">                      to use a specific dust curve instance with particular</span>
<span class="sd">                      properties.</span>
<span class="sd">            tau_v (dict):</span>
<span class="sd">                An overide to the dust model optical depth. Either:</span>
<span class="sd">                    - None, indicating the tau_v defined on the emission model</span>
<span class="sd">                        should be used.</span>
<span class="sd">                    - A float to use as the optical depth for all models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                          {&lt;label&gt;: float(&lt;tau_v&gt;)}</span>
<span class="sd">                      to use a specific optical depth with a particular</span>
<span class="sd">                      model or</span>
<span class="sd">                          {&lt;label&gt;: str(&lt;attribute&gt;)}</span>
<span class="sd">                      to use an attribute of the component as the optical</span>
<span class="sd">                      depth.</span>
<span class="sd">            fesc (dict):</span>
<span class="sd">                An overide to the emission model escape fraction. Either:</span>
<span class="sd">                    - None, indicating the fesc defined on the emission model</span>
<span class="sd">                      should be used.</span>
<span class="sd">                    - A float to use as the escape fraction for all models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                          {&lt;label&gt;: float(&lt;fesc&gt;)}</span>
<span class="sd">                      to use a specific escape fraction with a particular</span>
<span class="sd">                      model or</span>
<span class="sd">                          {&lt;label&gt;: str(&lt;attribute&gt;)}</span>
<span class="sd">                      to use an attribute of the component as the escape</span>
<span class="sd">                      fraction.</span>
<span class="sd">            covering_fraction (dict):</span>
<span class="sd">                An overide to the emission model covering fraction. Either:</span>
<span class="sd">                    - None, indicating the covering fraction defined on the</span>
<span class="sd">                      emission model should be used.</span>
<span class="sd">                    - A float to use as the covering fraction for all models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                          {&lt;label&gt;: float(&lt;covering_fraction&gt;)}</span>
<span class="sd">                      to use a specific covering fraction with a particular</span>
<span class="sd">                      model or</span>
<span class="sd">                          {&lt;label&gt;: str(&lt;attribute&gt;)}</span>
<span class="sd">                      to use an attribute of the component as the covering</span>
<span class="sd">                      fraction.</span>
<span class="sd">            mask (dict):</span>
<span class="sd">                An overide to the emission model mask. Either:</span>
<span class="sd">                    - None, indicating the mask defined on the emission model</span>
<span class="sd">                      should be used.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                      {&lt;label&gt;: {&quot;attr&quot;: &lt;attr&gt;, &quot;thresh&quot;: &lt;thresh&gt;, &quot;op&quot;:&lt;op&gt;}</span>
<span class="sd">                      to add a specific mask to a particular model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we have dust curves to apply, apply them</span>
        <span class="k">if</span> <span class="n">dust_curves</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dust_curves</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">dust_curve</span> <span class="ow">in</span> <span class="n">dust_curves</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">_dust_curve</span> <span class="o">=</span> <span class="n">dust_curve</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_dust_curve</span> <span class="o">=</span> <span class="n">dust_curves</span>

        <span class="c1"># If we have optical depths to apply, apply them</span>
        <span class="k">if</span> <span class="n">tau_v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tau_v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tau_v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">_tau_v</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">value</span><span class="p">,)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="s2">&quot;str&quot;</span><span class="p">))</span>
                        <span class="k">else</span> <span class="n">value</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_tau_v</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau_v</span><span class="p">,)</span>

        <span class="c1"># If we have escape fractions to apply, apply them</span>
        <span class="k">if</span> <span class="n">fesc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fesc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fesc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">_fesc</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_fesc</span> <span class="o">=</span> <span class="n">fesc</span>

        <span class="c1"># If we have covering fractions to apply, apply them</span>
        <span class="k">if</span> <span class="n">covering_fraction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">covering_fraction</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">covering_fraction</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">_covering_fraction</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_covering_fraction</span> <span class="o">=</span> <span class="n">covering_fraction</span>

        <span class="c1"># If we have masks to apply, apply them</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">mask</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">emission_model</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">add_mask</span><span class="p">(</span><span class="o">**</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_spectra</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">emitters</span><span class="p">,</span>
        <span class="n">dust_curves</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tau_v</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fesc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">covering_fraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">spectra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">particle_spectra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_is_related</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate stellar spectra as described by the emission model.</span>

<span class="sd">        NOTE: post processing methods defined on the model will be called</span>
<span class="sd">        once all spectra are made (these models are preceeded by post_ and</span>
<span class="sd">        take the dictionary of lines/spectra as an argument).</span>

<span class="sd">        Args:</span>
<span class="sd">            emitters (Stars/BlackHoles):</span>
<span class="sd">                The emitters to generate the spectra for in the form of a</span>
<span class="sd">                dictionary, {&quot;stellar&quot;: &lt;emitter&gt;, &quot;blackhole&quot;: &lt;emitter&gt;}.</span>
<span class="sd">            dust_curves (dict):</span>
<span class="sd">                An overide to the emisison model dust curves. Either:</span>
<span class="sd">                    - None, indicating the dust_curves defined on the emission</span>
<span class="sd">                      models should be used.</span>
<span class="sd">                    - A single dust curve to apply to all emission models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                          {&lt;label&gt;: &lt;dust_curve instance&gt;}</span>
<span class="sd">                      to use a specific dust curve instance with particular</span>
<span class="sd">                      properties.</span>
<span class="sd">            tau_v (dict):</span>
<span class="sd">                An overide to the dust model optical depth. Either:</span>
<span class="sd">                    - None, indicating the tau_v defined on the emission model</span>
<span class="sd">                        should be used.</span>
<span class="sd">                    - A float to use as the optical depth for all models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                            {&lt;label&gt;: float(&lt;tau_v&gt;)}</span>
<span class="sd">                        to use a specific optical depth with a particular</span>
<span class="sd">                        model or</span>
<span class="sd">                            {&lt;label&gt;: str(&lt;attribute&gt;)}</span>
<span class="sd">                        to use an attribute of the component as the optical</span>
<span class="sd">                        depth.</span>
<span class="sd">            fesc (dict):</span>
<span class="sd">                An overide to the emission model escape fraction. Either:</span>
<span class="sd">                    - None, indicating the fesc defined on the emission model</span>
<span class="sd">                      should be used.</span>
<span class="sd">                    - A float to use as the escape fraction for all models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                            {&lt;label&gt;: float(&lt;fesc&gt;)}</span>
<span class="sd">                      to use a specific escape fraction with a particular</span>
<span class="sd">                      model or</span>
<span class="sd">                            {&lt;label&gt;: str(&lt;attribute&gt;)}</span>
<span class="sd">                      to use an attribute of the component as the escape</span>
<span class="sd">                      fraction.</span>
<span class="sd">            covering_fraction (dict):</span>
<span class="sd">                An overide to the emission model covering fraction. Either:</span>
<span class="sd">                    - None, indicating the covering fraction defined on the</span>
<span class="sd">                      emission model should be used.</span>
<span class="sd">                    - A float to use as the covering fraction for all models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                            {&lt;label&gt;: float(&lt;covering_fraction&gt;)}</span>
<span class="sd">                      to use a specific covering fraction with a particular</span>
<span class="sd">                      model or</span>
<span class="sd">                            {&lt;label&gt;: str(&lt;attribute&gt;)}</span>
<span class="sd">                      to use an attribute of the component as the covering</span>
<span class="sd">                      fraction.</span>
<span class="sd">            mask (dict):</span>
<span class="sd">                An overide to the emission model mask. Either:</span>
<span class="sd">                    - None, indicating the mask defined on the emission model</span>
<span class="sd">                      should be used.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                      {&lt;label&gt;: {&quot;attr&quot;: &lt;attr&gt;, &quot;thresh&quot;: &lt;thresh&gt;, &quot;op&quot;:&lt;op&gt;}</span>
<span class="sd">                      to add a specific mask to a particular model.</span>
<span class="sd">            verbose (bool)</span>
<span class="sd">                Are we talking?</span>
<span class="sd">            spectra (dict)</span>
<span class="sd">                A dictionary of spectra to add to. This is used for recursive</span>
<span class="sd">                calls to this function.</span>
<span class="sd">            particle_spectra (dict)</span>
<span class="sd">                A dictionary of particle spectra to add to. This is used for</span>
<span class="sd">                recursive calls to this function.</span>
<span class="sd">            _is_related (bool)</span>
<span class="sd">                Are we generating related model spectra? If so we don&#39;t want</span>
<span class="sd">                to apply any post processing functions or delete any spectra,</span>
<span class="sd">                this will be done outside the recursive call.</span>
<span class="sd">            kwargs (dict)</span>
<span class="sd">                Any additional keyword arguments to pass to the generator</span>
<span class="sd">                function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict</span>
<span class="sd">                A dictionary of spectra which can be attached to the</span>
<span class="sd">                appropriate spectra attribute of the component</span>
<span class="sd">                (spectra/particle_spectra)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We don&#39;t want to modify the original emission model with any</span>
        <span class="c1"># modifications made here so we&#39;ll make a copy of it (this is a</span>
        <span class="c1"># shallow copy so very cheap and doesn&#39;t copy any pointed to objects</span>
        <span class="c1"># only their reference)</span>
        <span class="n">emission_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Before we do anything, check that we have the emitters we need</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># Galaxy is always missing</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">emitter</span> <span class="o">==</span> <span class="s2">&quot;galaxy&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">emitters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">emitter</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">emitter</span><span class="si">}</span><span class="s2"> in emitters.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Apply any overides we have</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_overrides</span><span class="p">(</span>
            <span class="n">emission_model</span><span class="p">,</span> <span class="n">dust_curves</span><span class="p">,</span> <span class="n">tau_v</span><span class="p">,</span> <span class="n">fesc</span><span class="p">,</span> <span class="n">covering_fraction</span><span class="p">,</span> <span class="n">mask</span>
        <span class="p">)</span>

        <span class="c1"># Make a spectra dictionary if we haven&#39;t got one yet</span>
        <span class="k">if</span> <span class="n">spectra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spectra</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">particle_spectra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">particle_spectra</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># We need to make sure the root is being saved, otherwise this is a bit</span>
        <span class="c1"># nonsensical.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_related</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2"> is not being saved. There&#39;s no point in &quot;</span>
                <span class="s2">&quot;generating at the root if they are not saved. Maybe you &quot;</span>
                <span class="s2">&quot;want to use a child model you are saving instead?&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Perform all extractions</span>
        <span class="n">spectra</span><span class="p">,</span> <span class="n">particle_spectra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_spectra</span><span class="p">(</span>
            <span class="n">emission_model</span><span class="p">,</span>
            <span class="n">emitters</span><span class="p">,</span>
            <span class="n">spectra</span><span class="p">,</span>
            <span class="n">particle_spectra</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># With all base spectra extracted we can now loop from bottom to top</span>
        <span class="c1"># of the tree creating each spectra</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">emission_model</span><span class="o">.</span><span class="n">_bottom_to_top</span><span class="p">:</span>
            <span class="c1"># Get this model</span>
            <span class="n">this_model</span> <span class="o">=</span> <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

            <span class="c1"># Get the spectra for the related models that don&#39;t appear in the</span>
            <span class="c1"># tree</span>
            <span class="k">for</span> <span class="n">related_model</span> <span class="ow">in</span> <span class="n">this_model</span><span class="o">.</span><span class="n">related_models</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">related_model</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spectra</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">rel_spectra</span><span class="p">,</span>
                        <span class="n">rel_particle_spectra</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">related_model</span><span class="o">.</span><span class="n">_get_spectra</span><span class="p">(</span>
                        <span class="n">emitters</span><span class="p">,</span>
                        <span class="n">dust_curves</span><span class="o">=</span><span class="n">dust_curves</span><span class="p">,</span>
                        <span class="n">tau_v</span><span class="o">=</span><span class="n">tau_v</span><span class="p">,</span>
                        <span class="n">fesc</span><span class="o">=</span><span class="n">fesc</span><span class="p">,</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                        <span class="n">spectra</span><span class="o">=</span><span class="n">spectra</span><span class="p">,</span>
                        <span class="n">particle_spectra</span><span class="o">=</span><span class="n">particle_spectra</span><span class="p">,</span>
                        <span class="n">_is_related</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">spectra</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rel_spectra</span><span class="p">)</span>
                    <span class="n">particle_spectra</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rel_particle_spectra</span><span class="p">)</span>

            <span class="c1"># Skip models for a different emitters</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">this_model</span><span class="o">.</span><span class="n">emitter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">emitters</span>
                <span class="ow">and</span> <span class="n">this_model</span><span class="o">.</span><span class="n">emitter</span> <span class="o">!=</span> <span class="s2">&quot;galaxy&quot;</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Get the emitter (as long as we aren&#39;t doing a combination for a</span>
            <span class="c1"># galaxy spectra</span>
            <span class="k">if</span> <span class="n">this_model</span><span class="o">.</span><span class="n">emitter</span> <span class="o">!=</span> <span class="s2">&quot;galaxy&quot;</span><span class="p">:</span>
                <span class="n">emitter</span> <span class="o">=</span> <span class="n">emitters</span><span class="p">[</span><span class="n">this_model</span><span class="o">.</span><span class="n">emitter</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">emitter</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Do we have to define a mask?</span>
            <span class="n">this_mask</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">mask_dict</span> <span class="ow">in</span> <span class="n">this_model</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
                <span class="n">this_mask</span> <span class="o">=</span> <span class="n">emitter</span><span class="o">.</span><span class="n">get_mask</span><span class="p">(</span><span class="o">**</span><span class="n">mask_dict</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">this_mask</span><span class="p">)</span>

            <span class="c1"># Are we doing a combination?</span>
            <span class="k">if</span> <span class="n">this_model</span><span class="o">.</span><span class="n">_is_combining</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">spectra</span><span class="p">,</span> <span class="n">particle_spectra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_spectra</span><span class="p">(</span>
                        <span class="n">emission_model</span><span class="p">,</span>
                        <span class="n">spectra</span><span class="p">,</span>
                        <span class="n">particle_spectra</span><span class="p">,</span>
                        <span class="n">this_model</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in </span><span class="si">{</span><span class="n">this_model</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="k">elif</span> <span class="n">this_model</span><span class="o">.</span><span class="n">_is_dust_attenuating</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">spectra</span><span class="p">,</span> <span class="n">particle_spectra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dust_attenuate_spectra</span><span class="p">(</span>
                        <span class="n">this_model</span><span class="p">,</span>
                        <span class="n">spectra</span><span class="p">,</span>
                        <span class="n">particle_spectra</span><span class="p">,</span>
                        <span class="n">emitter</span><span class="p">,</span>
                        <span class="n">this_mask</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in </span><span class="si">{</span><span class="n">this_model</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="k">elif</span> <span class="n">this_model</span><span class="o">.</span><span class="n">_is_dust_emitting</span> <span class="ow">or</span> <span class="n">this_model</span><span class="o">.</span><span class="n">_is_generating</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">spectra</span><span class="p">,</span> <span class="n">particle_spectra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_spectra</span><span class="p">(</span>
                        <span class="n">this_model</span><span class="p">,</span>
                        <span class="n">emission_model</span><span class="p">,</span>
                        <span class="n">spectra</span><span class="p">,</span>
                        <span class="n">particle_spectra</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span>
                        <span class="n">emitter</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in </span><span class="si">{</span><span class="n">this_model</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="c1"># Are we scaling the spectra?</span>
            <span class="k">for</span> <span class="n">scaler</span> <span class="ow">in</span> <span class="n">this_model</span><span class="o">.</span><span class="n">scale_by</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span> <span class="n">scaler</span><span class="p">):</span>
                    <span class="c1"># Ok, the emitter has this scaler, get it</span>
                    <span class="n">scaler_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">scaler</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">scaler_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">scaler_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span> <span class="n">scaler</span><span class="p">)</span>

                    <span class="c1"># Ensure we can actually multiply the spectra by it</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">scaler_arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="ow">and</span> <span class="n">spectra</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">scaler_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Can&#39;t scale a spectra with shape &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spectra</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> by an array of &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;shape </span><span class="si">{</span><span class="n">scaler_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Did you mean to &quot;</span>
                            <span class="s2">&quot;make particle spectra?&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">scaler_arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">spectra</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span>
                        <span class="ow">and</span> <span class="n">scaler_arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Can&#39;t scale a spectra with shape &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spectra</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> by an array of &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;shape </span><span class="si">{</span><span class="n">scaler_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Did you mean to &quot;</span>
                            <span class="s2">&quot;make particle spectra?&quot;</span>
                        <span class="p">)</span>

                    <span class="c1"># Scale the spectra by this attribute</span>
                    <span class="k">if</span> <span class="n">this_model</span><span class="o">.</span><span class="n">per_particle</span><span class="p">:</span>
                        <span class="n">particle_spectra</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scaler_arr</span>
                    <span class="n">spectra</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">_lnu</span> <span class="o">*=</span> <span class="n">scaler_arr</span>

                <span class="k">elif</span> <span class="n">scaler</span> <span class="ow">in</span> <span class="n">spectra</span><span class="p">:</span>
                    <span class="c1"># Compute the scaling</span>
                    <span class="k">if</span> <span class="n">this_model</span><span class="o">.</span><span class="n">per_particle</span><span class="p">:</span>
                        <span class="n">scaling</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">particle_spectra</span><span class="p">[</span>
                                <span class="n">scaler</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">measure_bolometric_luminosity</span><span class="p">()</span>
                            <span class="o">/</span> <span class="n">particle_spectra</span><span class="p">[</span>
                                <span class="n">label</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">measure_bolometric_luminosity</span><span class="p">()</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scaling</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">spectra</span><span class="p">[</span><span class="n">scaler</span><span class="p">]</span><span class="o">.</span><span class="n">measure_bolometric_luminosity</span><span class="p">()</span>
                            <span class="o">/</span> <span class="n">spectra</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">measure_bolometric_luminosity</span><span class="p">()</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">value</span>

                    <span class="c1"># Scale the spectra (handling 1D and 2D cases)</span>
                    <span class="k">if</span> <span class="n">this_model</span><span class="o">.</span><span class="n">per_particle</span><span class="p">:</span>
                        <span class="n">particle_spectra</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scaling</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="n">spectra</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">_lnu</span> <span class="o">*=</span> <span class="n">scaling</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Can&#39;t scale spectra by </span><span class="si">{</span><span class="n">scaler</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># Only apply post processing and deletion if we aren&#39;t in a recursive</span>
        <span class="c1"># related model call</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_related</span><span class="p">:</span>
            <span class="c1"># Apply any post processing functions</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing</span><span class="p">:</span>
                <span class="n">spectra</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">emitters</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">particle_spectra</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">particle_spectra</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">particle_spectra</span><span class="p">,</span> <span class="n">emitters</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="c1"># Loop over all models and delete those spectra if we aren&#39;t saving</span>
            <span class="c1"># them (we have to this after post processing incase the deleted</span>
            <span class="c1"># spectra are needed during post processing)</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">save</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">spectra</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">spectra</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">per_particle</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">particle_spectra</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">particle_spectra</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">spectra</span><span class="p">,</span> <span class="n">particle_spectra</span>

    <span class="k">def</span> <span class="nf">_get_lines</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line_ids</span><span class="p">,</span>
        <span class="n">emitters</span><span class="p">,</span>
        <span class="n">dust_curves</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tau_v</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fesc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">covering_fraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">particle_lines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_is_related</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate stellar lines as described by the emission model.</span>

<span class="sd">        NOTE: post processing methods defined on the model will be called</span>
<span class="sd">        once all spectra are made (these models are preceeded by post_ and</span>
<span class="sd">        take the dictionary of lines/spectra as an argument).</span>

<span class="sd">        Args:</span>
<span class="sd">            line_ids (list):</span>
<span class="sd">                The line ids to extract.</span>
<span class="sd">            emitters (Stars/BlackHoles):</span>
<span class="sd">                The emitters to generate the lines for in the form of a</span>
<span class="sd">                dictionary, {&quot;stellar&quot;: &lt;emitter&gt;, &quot;blackhole&quot;: &lt;emitter&gt;}.</span>
<span class="sd">            dust_curves (dict):</span>
<span class="sd">                An overide to the emisison model dust curves. Either:</span>
<span class="sd">                    - None, indicating the dust_curves defined on the emission</span>
<span class="sd">                      models should be used.</span>
<span class="sd">                    - A single dust curve to apply to all emission models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                          {&lt;label&gt;: &lt;dust_curve instance&gt;}</span>
<span class="sd">                      to use a specific dust curve instance with particular</span>
<span class="sd">                      properties.</span>
<span class="sd">            tau_v (dict):</span>
<span class="sd">                An overide to the dust model optical depth. Either:</span>
<span class="sd">                    - None, indicating the tau_v defined on the emission model</span>
<span class="sd">                        should be used.</span>
<span class="sd">                    - A float to use as the optical depth for all models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                            {&lt;label&gt;: float(&lt;tau_v&gt;)}</span>
<span class="sd">                        to use a specific optical depth with a particular</span>
<span class="sd">                        model or</span>
<span class="sd">                            {&lt;label&gt;: str(&lt;attribute&gt;)}</span>
<span class="sd">                        to use an attribute of the component as the optical</span>
<span class="sd">                        depth.</span>
<span class="sd">            fesc (dict):</span>
<span class="sd">                An overide to the emission model escape fraction. Either:</span>
<span class="sd">                    - None, indicating the fesc defined on the emission model</span>
<span class="sd">                      should be used.</span>
<span class="sd">                    - A float to use as the escape fraction for all models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                            {&lt;label&gt;: float(&lt;fesc&gt;)}</span>
<span class="sd">                      to use a specific escape fraction with a particular</span>
<span class="sd">                      model or</span>
<span class="sd">                            {&lt;label&gt;: str(&lt;attribute&gt;)}</span>
<span class="sd">                      to use an attribute of the component as the escape</span>
<span class="sd">                      fraction.</span>
<span class="sd">            covering_fraction (dict):</span>
<span class="sd">                An overide to the emission model covering fraction. Either:</span>
<span class="sd">                    - None, indicating the covering fraction defined on the</span>
<span class="sd">                      emission model should be used.</span>
<span class="sd">                    - A float to use as the covering fraction for all models.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                            {&lt;label&gt;: float(&lt;covering_fraction&gt;)}</span>
<span class="sd">                      to use a specific covering fraction with a particular</span>
<span class="sd">                      model or</span>
<span class="sd">                            {&lt;label&gt;: str(&lt;attribute&gt;)}</span>
<span class="sd">                      to use an attribute of the component as the covering</span>
<span class="sd">                      fraction.</span>
<span class="sd">            mask (dict):</span>
<span class="sd">                An overide to the emission model mask. Either:</span>
<span class="sd">                    - None, indicating the mask defined on the emission model</span>
<span class="sd">                      should be used.</span>
<span class="sd">                    - A dictionary of the form:</span>
<span class="sd">                      {&lt;label&gt;: {&quot;attr&quot;: &lt;attr&gt;, &quot;thresh&quot;: &lt;thresh&gt;, &quot;op&quot;:&lt;op&gt;}</span>
<span class="sd">                      to add a specific mask to a particular model.</span>
<span class="sd">            verbose (bool)</span>
<span class="sd">                Are we talking?</span>
<span class="sd">            lines (dict)</span>
<span class="sd">                A dictionary of lines to add to. This is used for recursive</span>
<span class="sd">                calls to this function.</span>
<span class="sd">            particle_lines (dict)</span>
<span class="sd">                A dictionary of particle lines to add to. This is used for</span>
<span class="sd">                recursive calls to this function.</span>
<span class="sd">            _is_related (bool)</span>
<span class="sd">                Are we generating related model lines? If so we don&#39;t want</span>
<span class="sd">                to apply any post processing functions or delete any lines,</span>
<span class="sd">                this will be done outside the recursive call.</span>
<span class="sd">            kwargs (dict)</span>
<span class="sd">                Any additional keyword arguments to pass to the generator</span>
<span class="sd">                function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict</span>
<span class="sd">                A dictionary of lines which can be attached to the</span>
<span class="sd">                appropriate lines attribute of the component</span>
<span class="sd">                (lines/particle_lines)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We don&#39;t want to modify the original emission model with any</span>
        <span class="c1"># modifications made here so we&#39;ll make a copy of it (this is a</span>
        <span class="c1"># shallow copy so very cheap and doesn&#39;t copy any pointed to objects</span>
        <span class="c1"># only their reference)</span>
        <span class="n">emission_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Apply any overides we have</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_overrides</span><span class="p">(</span>
            <span class="n">emission_model</span><span class="p">,</span> <span class="n">dust_curves</span><span class="p">,</span> <span class="n">tau_v</span><span class="p">,</span> <span class="n">fesc</span><span class="p">,</span> <span class="n">covering_fraction</span><span class="p">,</span> <span class="n">mask</span>
        <span class="p">)</span>

        <span class="c1"># If we haven&#39;t got a lines dictionary yet we&#39;ll make one</span>
        <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">particle_lines</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">particle_lines</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># We need to make sure the root is being saved, otherwise this is a bit</span>
        <span class="c1"># nonsensical.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_related</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2"> is not being saved. There&#39;s no point in &quot;</span>
                <span class="s2">&quot;generating at the root if they are not saved. Maybe you &quot;</span>
                <span class="s2">&quot;want to use a child model you are saving instead?&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Perform all extractions</span>
        <span class="n">lines</span><span class="p">,</span> <span class="n">particle_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_lines</span><span class="p">(</span>
            <span class="n">line_ids</span><span class="p">,</span>
            <span class="n">emission_model</span><span class="p">,</span>
            <span class="n">emitters</span><span class="p">,</span>
            <span class="n">lines</span><span class="p">,</span>
            <span class="n">particle_lines</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># With all base lines extracted we can now loop from bottom to top</span>
        <span class="c1"># of the tree creating each lines</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">emission_model</span><span class="o">.</span><span class="n">_bottom_to_top</span><span class="p">:</span>
            <span class="c1"># Get this model</span>
            <span class="n">this_model</span> <span class="o">=</span> <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

            <span class="c1"># Get the spectra for the related models that don&#39;t appear in the</span>
            <span class="c1"># tree</span>
            <span class="k">for</span> <span class="n">related_model</span> <span class="ow">in</span> <span class="n">this_model</span><span class="o">.</span><span class="n">related_models</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">related_model</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="n">rel_lines</span><span class="p">,</span> <span class="n">rel_particle_lines</span> <span class="o">=</span> <span class="n">related_model</span><span class="o">.</span><span class="n">_get_lines</span><span class="p">(</span>
                        <span class="n">line_ids</span><span class="p">,</span>
                        <span class="n">emitters</span><span class="p">,</span>
                        <span class="n">dust_curves</span><span class="o">=</span><span class="n">dust_curves</span><span class="p">,</span>
                        <span class="n">tau_v</span><span class="o">=</span><span class="n">tau_v</span><span class="p">,</span>
                        <span class="n">fesc</span><span class="o">=</span><span class="n">fesc</span><span class="p">,</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                        <span class="n">lines</span><span class="o">=</span><span class="n">lines</span><span class="p">,</span>
                        <span class="n">particle_lines</span><span class="o">=</span><span class="n">particle_lines</span><span class="p">,</span>
                        <span class="n">_is_related</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">lines</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rel_lines</span><span class="p">)</span>
                    <span class="n">particle_lines</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rel_particle_lines</span><span class="p">)</span>

            <span class="c1"># Skip models for a different emitters</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">this_model</span><span class="o">.</span><span class="n">emitter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">emitters</span>
                <span class="ow">and</span> <span class="n">this_model</span><span class="o">.</span><span class="n">emitter</span> <span class="o">!=</span> <span class="s2">&quot;galaxy&quot;</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Get the emitter (as long as we aren&#39;t doing a combination for a</span>
            <span class="c1"># galaxy spectra</span>
            <span class="k">if</span> <span class="n">this_model</span><span class="o">.</span><span class="n">emitter</span> <span class="o">!=</span> <span class="s2">&quot;galaxy&quot;</span><span class="p">:</span>
                <span class="n">emitter</span> <span class="o">=</span> <span class="n">emitters</span><span class="p">[</span><span class="n">this_model</span><span class="o">.</span><span class="n">emitter</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">emitter</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Do we have to define a mask?</span>
            <span class="n">this_mask</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">mask_dict</span> <span class="ow">in</span> <span class="n">this_model</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
                <span class="n">this_mask</span> <span class="o">=</span> <span class="n">emitter</span><span class="o">.</span><span class="n">get_mask</span><span class="p">(</span><span class="o">**</span><span class="n">mask_dict</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">this_mask</span><span class="p">)</span>

            <span class="c1"># Are we doing a combination?</span>
            <span class="k">if</span> <span class="n">this_model</span><span class="o">.</span><span class="n">_is_combining</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lines</span><span class="p">,</span> <span class="n">particle_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_lines</span><span class="p">(</span>
                        <span class="n">line_ids</span><span class="p">,</span>
                        <span class="n">emission_model</span><span class="p">,</span>
                        <span class="n">lines</span><span class="p">,</span>
                        <span class="n">particle_lines</span><span class="p">,</span>
                        <span class="n">this_model</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in </span><span class="si">{</span><span class="n">this_model</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="k">elif</span> <span class="n">this_model</span><span class="o">.</span><span class="n">_is_dust_attenuating</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lines</span><span class="p">,</span> <span class="n">particle_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dust_attenuate_lines</span><span class="p">(</span>
                        <span class="n">line_ids</span><span class="p">,</span>
                        <span class="n">this_model</span><span class="p">,</span>
                        <span class="n">lines</span><span class="p">,</span>
                        <span class="n">particle_lines</span><span class="p">,</span>
                        <span class="n">emitter</span><span class="p">,</span>
                        <span class="n">this_mask</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in </span><span class="si">{</span><span class="n">this_model</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="k">elif</span> <span class="n">this_model</span><span class="o">.</span><span class="n">_is_dust_emitting</span> <span class="ow">or</span> <span class="n">this_model</span><span class="o">.</span><span class="n">_is_generating</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lines</span><span class="p">,</span> <span class="n">particle_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_lines</span><span class="p">(</span>
                        <span class="n">line_ids</span><span class="p">,</span>
                        <span class="n">this_model</span><span class="p">,</span>
                        <span class="n">emission_model</span><span class="p">,</span>
                        <span class="n">lines</span><span class="p">,</span>
                        <span class="n">particle_lines</span><span class="p">,</span>
                        <span class="n">emitter</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in </span><span class="si">{</span><span class="n">this_model</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="c1"># Are we scaling the spectra?</span>
            <span class="k">for</span> <span class="n">scaler</span> <span class="ow">in</span> <span class="n">this_model</span><span class="o">.</span><span class="n">scale_by</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span> <span class="n">scaler</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">line_id</span> <span class="ow">in</span> <span class="n">line_ids</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">this_model</span><span class="o">.</span><span class="n">per_particle</span><span class="p">:</span>
                            <span class="n">particle_lines</span><span class="p">[</span><span class="n">label</span><span class="p">][</span>
                                <span class="n">line_id</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">_luminosity</span> <span class="o">*=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span> <span class="n">scaler</span><span class="p">)</span>
                            <span class="n">particle_lines</span><span class="p">[</span><span class="n">label</span><span class="p">][</span>
                                <span class="n">line_id</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">_continuum</span> <span class="o">*=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span> <span class="n">scaler</span><span class="p">)</span>
                        <span class="n">lines</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">line_id</span><span class="p">]</span><span class="o">.</span><span class="n">_luminosity</span> <span class="o">*=</span> <span class="nb">getattr</span><span class="p">(</span>
                            <span class="n">emitter</span><span class="p">,</span> <span class="n">scaler</span>
                        <span class="p">)</span>
                        <span class="n">lines</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">line_id</span><span class="p">]</span><span class="o">.</span><span class="n">_continuum</span> <span class="o">*=</span> <span class="nb">getattr</span><span class="p">(</span>
                            <span class="n">emitter</span><span class="p">,</span> <span class="n">scaler</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Can&#39;t scale lines by </span><span class="si">{</span><span class="n">scaler</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># Only convert to LineCollections, apply post processing and deletion</span>
        <span class="c1"># if we aren&#39;t in a recursive related model call</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_related</span><span class="p">:</span>
            <span class="c1"># Finally, loop over everything we&#39;ve created and convert the</span>
            <span class="c1"># nested dictionaries to LineCollections</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="c1"># If we are in a related model we might have already done this</span>
                <span class="c1"># conversion</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">lines</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">per_particle</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">particle_lines</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="nb">dict</span>
                <span class="p">):</span>
                    <span class="n">particle_lines</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span>
                        <span class="n">particle_lines</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                    <span class="p">)</span>

            <span class="c1"># Apply any post processing functions</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">emitters</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">particle_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">particle_lines</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">particle_lines</span><span class="p">,</span> <span class="n">emitters</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="c1"># Loop over all models and delete those lines if we aren&#39;t saving</span>
            <span class="c1"># them (we have to this after post processing incase the deleted</span>
            <span class="c1"># lines are needed during post processing)</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">emission_model</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">save</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">per_particle</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">particle_lines</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">particle_lines</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">lines</span><span class="p">,</span> <span class="n">particle_lines</span></div>



<div class="viewcode-block" id="StellarEmissionModel">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.StellarEmissionModel">[docs]</a>
<span class="k">class</span> <span class="nc">StellarEmissionModel</span><span class="p">(</span><span class="n">EmissionModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An emission model for stellar components.</span>

<span class="sd">    This is a simple wrapper to quickly apply that the emitter a model</span>
<span class="sd">    should act on is stellar.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        emitter (str):</span>
<span class="sd">            The emitter this model is for.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate a StellarEmissionModel instance.&quot;&quot;&quot;</span>
        <span class="n">EmissionModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emitter</span> <span class="o">=</span> <span class="s2">&quot;stellar&quot;</span></div>



<div class="viewcode-block" id="BlackHoleEmissionModel">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.BlackHoleEmissionModel">[docs]</a>
<span class="k">class</span> <span class="nc">BlackHoleEmissionModel</span><span class="p">(</span><span class="n">EmissionModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An emission model for black hole components.</span>

<span class="sd">    This is a simple wrapper to quickly apply that the emitter a model</span>
<span class="sd">    should act on is a black hole.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        emitter (str):</span>
<span class="sd">            The emitter this model is for.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate a BlackHoleEmissionModel instance.&quot;&quot;&quot;</span>
        <span class="n">EmissionModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emitter</span> <span class="o">=</span> <span class="s2">&quot;blackhole&quot;</span></div>



<div class="viewcode-block" id="GalaxyEmissionModel">
<a class="viewcode-back" href="../../../_autosummary/synthesizer.emission_models.base_model.html#synthesizer.emission_models.base_model.GalaxyEmissionModel">[docs]</a>
<span class="k">class</span> <span class="nc">GalaxyEmissionModel</span><span class="p">(</span><span class="n">EmissionModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An emission model for whole galaxy.</span>

<span class="sd">    A galaxy model sets emitter to &quot;galaxy&quot; to flag to the get_spectra method</span>
<span class="sd">    that the model is for a galaxy. By definition a galaxy level spectra can</span>
<span class="sd">    only be a combination of component spectra.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        emitter (str):</span>
<span class="sd">            The emitter this model is for.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate a GalaxyEmissionModel instance.&quot;&quot;&quot;</span>
        <span class="n">EmissionModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emitter</span> <span class="o">=</span> <span class="s2">&quot;galaxy&quot;</span>

        <span class="c1"># Ensure we aren&#39;t extracting, this cannot be done for a galaxy.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_extracting</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;A GalaxyEmissionModel cannot be an extraction model.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Ensure we aren&#39;t trying to make a per particle galaxy emission</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_particle</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InconsistentArguments</span><span class="p">(</span>
                <span class="s2">&quot;A GalaxyEmissionModel cannot be a per particle model.&quot;</span>
            <span class="p">)</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Chris Lovell, Will Roper, Aswin Vijayan, Stephen Wilkins
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=9f1547ce"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>